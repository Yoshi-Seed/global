<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FAQ Article | Seed Planning</title>
  <style>
    body { font-family: "Inter","Noto Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Arial; margin: 24px; line-height: 1.7; color:#21343b; }
    a{ color:#2f6f7e; text-decoration:none } a:hover{text-decoration:underline}
    header{ margin-bottom: 18px; }
    h1{ margin: 0 0 6px; font-size: 24px; }
    .meta{ color:#5e7a85; font-size: 14px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{ font-size:12px; background:#edf7f7; border:1px solid #d9ecec; padding:2px 8px; border-radius:999px; }
    .content{ margin-top: 18px; }
    mark{ background:#fff3b0; padding:0 .2em }
    .related { margin-top: 36px; }
    .related h2{ font-size:18px; margin: 0 0 10px; border-bottom:2px solid #5baaae; padding-bottom:6px; }
    .related ul{ list-style: none; padding: 0; margin: 0; }
    .related li{ margin: 6px 0; }
  </style>
</head>
<body>
  <a href="index.html">← Back to FAQs</a>
  <header>
    <h1 id="title"></h1>
    <div id="meta" class="meta"></div>
  </header>
  <section class="content">
    <p id="answer"></p>
  </section>
  <section class="related" id="related" hidden>
    <h2>Articles in this section</h2>
    <ul id="relatedList"></ul>
  </section>

  <script src="data/faqs.js"></script>
  <script>
    function escapeHTML(s){return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const q  = params.get("q") || "";

    // データ取得（window.FAQS 優先）
    let ALL = [];
    try { if (Array.isArray(window.FAQS)) ALL = window.FAQS; } catch(e){}
    try { if (!ALL.length && typeof FAQS !== 'undefined') ALL = FAQS; } catch(e){}

    const byId = new Map(); for(const it of ALL){ byId.set(it.id, it); }
    const it = byId.get(id);

    if (!it){
      document.getElementById('title').textContent = 'Article not found';
      document.getElementById('answer').innerHTML = 'The requested article does not exist. <a href="index.html">Back to index</a>';
    } else {
      document.getElementById('title').textContent = it.question;
      const cats = (it.categories||[]).map(c=>`<span class="tag">#${escapeHTML(c)}</span>`).join(' ');
      document.getElementById('meta').innerHTML = cats || '<span class="tag">#Uncategorized</span>';

      // 本文（q があればハイライト）
      const raw = String(it.answer||'');
      if (!q){
        document.getElementById('answer').textContent = raw;
      } else {
        const esc = escapeHTML(raw);
        const patt = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'ig');
        document.getElementById('answer').innerHTML = esc.replace(patt, m=>`<mark>${m}</mark>`);
      }

      // 関連（同カテゴリ内 上限10）
      const rel = ALL.filter(x =>
        x.id !== it.id &&
        (Array.isArray(x.categories) && Array.isArray(it.categories)) &&
        x.categories.some(c => it.categories.includes(c))
      ).slice(0,10);

      if (rel.length){
        const ul = document.getElementById('relatedList');
        ul.innerHTML = rel.map(x=>`<li><a href="articles.html?id=${encodeURIComponent(x.id)}">${escapeHTML(x.question)}</a></li>`).join('');
        document.getElementById('related').hidden = false;
      }
    }
  </script>
</body>
</html>
