<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FAQ Article | Seed Planning</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2248%22 fill=%22%235baaae%22/><text x=%2250%22 y=%2263%22 font-size=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22>SP</text></svg>">
<style>
  :root{ --ink:#21343b; --muted:#5e7a85; --line:#e6eff1; --chip:#edf7f7; }
  body{font-family: "Inter","Noto Sans","Noto Sans JP",system-ui; margin:0; color:var(--ink); line-height:1.7}
  .wrap{max-width:860px; margin:0 auto; padding:20px}
  a{color:#2f6f7e; text-decoration:none} a:hover{text-decoration:underline}
  .tag{font-size:12px;color:var(--muted); background:var(--chip); border:1px solid #d9ecec; padding:2px 8px; border-radius:999px; margin-right:6px}
  header h1{margin:10px 0 6px}
  nav{margin:10px 0 16px}
  .notfound{color:var(--muted)}
  details.debug{margin-top:18px; font-size:13px; color:#49606a}
</style>
</head>
<body>
  <main class="wrap">
    <nav><a href="index.html">← Back to FAQ</a></nav>
    <article id="article"></article>
  </main>

  <script src="data/faqs.js?v=<?ts?>"></script>
  <script>
    async function fetchCSV(u){
      const res = await fetch(u+(u.includes("?")?"&":"?")+"v="+Date.now(),{cache:"no-store"});
      if(!res.ok) return []; const t=await res.text(); return parseCSV(t);
    }
    function parseCSV(text){
      const rows=[], out=[]; let cur=[''], q=false; const s=String(text||'');
      for(let i=0;i<s.length;i++){
        const c=s[i];
        if(q){ if(c=='"'){ if(s[i+1]=='"'){cur[cur.length-1]+='"'; i++;} else q=false; } else cur[cur.length-1]+=c; }
        else { if(c=='"') q=true; else if(c==',') cur.push(''); else if(c=='\n'||c=='\r'){ if(cur.length>1||cur[0]!=='') rows.push(cur); cur=['']; } else cur[cur.length-1]+=c; }
      }
      if(cur.length>1||cur[0]!=='') rows.push(cur);
      if(!rows.length) return [];
      const head=rows[0].map(h=>h.trim());
      for(let i=1;i<rows.length;i++){
        const r=rows[i], o={}; head.forEach((h,k)=>o[h]=(r[k]??'').trim());
        if(o.categories) o.categories=o.categories.split(/\s*[;|,]\s*/).filter(Boolean);
        out.push(o);
      } return out;
    }
    function escapeHTML(s){return String(s||"").replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m]))}
    function param(n){ return new URL(location.href).searchParams.get(n); }
    function mapById(a){ const m=new Map(); a.forEach(x=>{ if(x&&x.id) m.set(String(x.id),x); }); return m; }

    async function loadAll(){
      let csv=[]; try{ csv=await fetchCSV("data/index.csv"); }catch(_){}
      let js=[]; try{
        if(Array.isArray(window.FAQS)&&window.FAQS.length) js=window.FAQS;
        else if(typeof FAQS!=="undefined"&&Array.isArray(FAQS)&&FAQS.length) js=FAQS;
      }catch(_){}
      const m=new Map(); js.forEach(x=>x&&x.id&&m.set(String(x.id),x)); csv.forEach(x=>x&&x.id&&m.set(String(x.id),x)); // CSV優先
      return [...m.values()];
    }

    (async function(){
      const all=await loadAll(), id=String(param('id')||''), art=document.getElementById('article');
      const m=mapById(all);
      // 厳密一致→正規化一致（全角/半角/ダッシュ違い）
      let f=m.get(id);
      if(!f){
        const norm=s=>String(s||'').toLowerCase().replace(/[\u2010-\u2015\u2212]/g,'-').replace(/[Ａ-Ｚａ-ｚ０-９]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0));
        const nid=norm(id); for(const k of m.keys()){ if(norm(k)===nid){ f=m.get(k); break; } }
      }
      if(!f){
        const ids=all.map(x=>x.id).filter(Boolean).slice(0,100);
        art.innerHTML=`<p class="notfound">Article not found. It may have been updated or removed.</p>
        <details class="debug"><summary>Debug: Available IDs (first 100)</summary><pre>${escapeHTML(ids.join("\\n"))}</pre></details>`;
        return;
      }
      document.title=f.question+' | Seed Planning';
      art.innerHTML=`<header><h1>${escapeHTML(f.question)}</h1>
        <div class="meta">${(f.categories||[]).map(c=>`<span class="tag">#${escapeHTML(c)}</span>`).join(' ')}</div>
      </header>
      <section class="content"><p>${escapeHTML(String(f.answer||''))}</p></section>`;
    })();
  </script>
</body>
</html>
