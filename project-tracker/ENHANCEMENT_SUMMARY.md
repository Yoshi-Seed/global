# プロジェクトトラッカー機能強化サマリー

**実装日**: 2025-12-25  
**バージョン**: 2.1.0  
**対象**: データ品質と可視化の高度化

---

## 📋 実装内容

### A. データ品質と集計ロジックの強化

#### A-1. 集計ロジックの外部設定化

**変更ファイル**: `js/config.js`

**追加内容**:
```javascript
const AGGREGATION_CONFIG = {
  // 診療科フィールドの除外値（完全一致）
  EXACT_EXCLUDE_VALUES: [...],
  
  // 診療科として認識するキーワード（部分一致）
  SPECIALTY_KEYWORDS: [...],
  
  // フィールドごとの集計フィルタ基準
  FILTER_THRESHOLDS: {
    specialty: { prev: 1, curr: 1 },
    diseaseName: { prev: 1, curr: 1 },
    client: { prev: 2, curr: 3 },
    default: { prev: 5, curr: 8 }
  }
};
```

**メリット**:
- ✅ 除外ルールとキーワードが一元管理され、メンテナンス性向上
- ✅ HTML ファイルを編集せずに設定変更が可能
- ✅ フィールドごとの閾値を柔軟に調整可能
- ✅ 将来的に Google Sheets からマスタ取得する拡張が容易

#### A-2. index.html の集計ロジック最適化

**変更ファイル**: `index.html`

**変更内容**:
- ハードコードされた `EXACT_EXCLUDE_VALUES` と `SPECIALTY_KEYWORDS` を削除
- `config.js` の `AGGREGATION_CONFIG` から動的に読み込むように変更
- フィルタ閾値も `FILTER_THRESHOLDS` から取得

**削減コード量**: 約30行

---

### B. UI/UX・可視化の高度化

#### B-1. Chart.js ライブラリの導入

**追加内容**:
```html
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
```

**理由**:
- 軽量（11KB gzip）で高性能
- インタラクティブな操作（ホバー、クリック）に標準対応
- レスポンシブデザインに完全対応
- アニメーション効果が豊富

#### B-2. インタラクティブなチャート実装

**変更ファイル**: `index.html`

**新機能**:

1. **チャート表示の切り替えボタン**
   - 各セクション（疾患、診療科、対象者タイプ、クライアント）にトグルボタンを追加
   - バーチャート（デフォルト） ⇔ 円グラフ を切り替え可能

2. **円グラフの高度な機能**
   - **インタラクティブツールチップ**:
     - 直近3ヵ月の件数と構成比
     - 昨年同期の件数
     - 前年比の変化（件数・パーセント）
   - **ドリルダウン機能**:
     - 円グラフの各セグメントをクリック
     - 該当カテゴリーの案件一覧ページへ自動遷移
     - フィルタが適用された状態で表示

3. **美しいカラーパレット**
   - 各チャートタイプごとに最適化された配色
   - Tailwind CSS のカラーシステムと統一

**実装詳細**:

```javascript
// グローバル変数でチャートインスタンスを保持
let chartInstances = { disease: null, specialty: null, targetType: null, client: null };
let chartData = { disease: null, specialty: null, targetType: null, client: null };

// チャート表示の切り替え
function toggleChartView(chartType) { ... }

// Chart.js 円グラフを描画
function renderPieChart(chartType, comparisonResult) {
  // ドリルダウン機能を含む
  onClick: (event, activeElements) => {
    window.location.href = `projects.html?${filterField}=${filterParam}`;
  }
}
```

---

## 🎯 達成した改善点

### 1. データ品質と集計ロジックの強化

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| **除外ルール管理** | HTML 内にハードコード | config.js で一元管理 |
| **設定変更** | HTML 編集が必要 | config.js のみ編集 |
| **拡張性** | 各ファイルで個別対応 | 全ファイルで共通設定を参照 |
| **閾値調整** | コード内の if-else 分岐 | FILTER_THRESHOLDS で定義 |

### 2. UI/UX・可視化の高度化

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| **チャート種類** | 静的バーチャートのみ | バー + 円グラフ（切替可能） |
| **インタラクション** | なし | ホバーツールチップ + クリックドリルダウン |
| **データ詳細表示** | 件数のみ | 件数・構成比・前年比・変化率 |
| **案件検索連携** | 手動でフィルタ設定 | ワンクリックで絞り込み |

---

## 📊 具体的な利用シーン

### シーン 1: 疾患カテゴリーの分析

1. ダッシュボードを開く
2. 「疾患カテゴリー Top 5」セクションの **「円グラフ表示」** ボタンをクリック
3. 円グラフの各セグメントにマウスホバー
   - **直近3ヵ月**: アルツハイマー型認知症 25件 (35.2%)
   - **昨年同期**: 18件
   - **変化**: +7件 (+38.9%)
4. 「アルツハイマー型認知症」のセグメントをクリック
5. **案件検索ページへ自動遷移**（疾患名フィルタ適用済み）
6. 該当案件の詳細を確認・比較

### シーン 2: 診療科別の傾向分析

1. 「専門（診療科）Top 5」セクションで **円グラフ表示**
2. 「脳神経内科」のセグメントをクリック
3. 脳神経内科の過去案件一覧を即座に確認
4. リクルート条件や対象者種別の傾向を分析

### シーン 3: クライアント別の実績確認

1. 「クライアント Top 5」セクションで **円グラフ表示**
2. ツールチップで前年比を確認
   - 「The Link Group」: +12件 (+25.0%)
   - 「Blue Matter Consulting」: -3件 (-8.1%)
3. 成長しているクライアントのセグメントをクリック
4. 該当クライアントの案件詳細を確認

---

## 🚀 今後の拡張方向性

### 短期（すぐに実装可能）

1. **折れ線グラフの追加**
   - 月次推移をグラフ化
   - トレンド分析を可視化

2. **比較チャートの強化**
   - 前年比を並列バーで表示
   - 増減をより直感的に理解

3. **フィルタ条件の保存**
   - よく使うフィルタをブックマーク
   - ワンクリックで再適用

### 中期（データ整備が必要）

4. **マスタ管理の徹底**
   - register.html の診療科マスタを拡充
   - 既存データの正規化スクリプト作成
   - SPECIALTY_KEYWORDS の段階的削減

5. **動的マスタ管理**
   - Google Sheets から診療科マスタを取得
   - データとマスタの一元管理
   - リアルタイム同期

6. **高度な分析機能**
   - リクルート成功率の分析
   - 診療科×疾患のクロス集計
   - 地域別・期間別の多次元分析

### 長期（システム全体の拡張）

7. **ダッシュボードのカスタマイズ**
   - ユーザーごとに表示項目を選択
   - レイアウトの自由配置
   - お気に入りチャートの保存

8. **レポート自動生成**
   - 月次レポートのPDF出力
   - 定期的なメール配信
   - カスタムテンプレート対応

9. **AIによる予測・推薦**
   - 類似案件の自動推薦
   - リクルート難易度の予測
   - 最適なリクルート会社の提案

---

## 📝 使用方法

### 設定変更（除外ルール・キーワード）

`js/config.js` の `AGGREGATION_CONFIG` を編集：

```javascript
// 例: 新しい除外値を追加
EXACT_EXCLUDE_VALUES: [
  '医師', '患者', '介護者', 'KOL', '看護師', 
  '定性', '定量', '薬剤師', 'その他', '家族',
  '新しい除外値' // ← 追加
],

// 例: 診療科キーワードを追加
SPECIALTY_KEYWORDS: [
  '内科', '外科', '科医', '医', '専門医',
  // ... 既存のキーワード ...
  '新しいキーワード' // ← 追加
],

// 例: フィルタ閾値を変更
FILTER_THRESHOLDS: {
  specialty: { prev: 2, curr: 2 }, // ← より厳しい基準に変更
  diseaseName: { prev: 1, curr: 1 },
  client: { prev: 3, curr: 5 }, // ← より厳しい基準に変更
  default: { prev: 5, curr: 8 }
}
```

### チャート表示の切り替え

1. ダッシュボードを開く
2. 各セクション（疾患、診療科、対象者タイプ、クライアント）のヘッダー右側にある **「円グラフ表示」** ボタンをクリック
3. 円グラフが表示される（ボタンが「バーチャート表示」に変わる）
4. もう一度クリックすると元のバーチャートに戻る

### ドリルダウン機能の使用

1. 円グラフ表示に切り替え
2. 任意のセグメント（疾患名、診療科、クライアント等）をクリック
3. 案件検索ページへ自動遷移（該当カテゴリーでフィルタ適用済み）
4. 詳細な案件情報を確認

---

## 🔧 トラブルシューティング

### Q1: 円グラフが表示されない

**原因**: Chart.js が読み込まれていない可能性があります。

**解決方法**:
1. ブラウザのコンソールを開く（F12 → Console）
2. エラーメッセージを確認
3. インターネット接続を確認（CDN から Chart.js を読み込むため）

### Q2: ドリルダウンが動作しない

**原因**: JavaScript エラーが発生している可能性があります。

**解決方法**:
1. ブラウザのコンソールを開く
2. エラーメッセージを確認
3. ページをリロード（Ctrl+R または Cmd+R）

### Q3: 設定変更が反映されない

**原因**: ブラウザのキャッシュが残っている可能性があります。

**解決方法**:
1. スーパーリロード（Ctrl+Shift+R または Cmd+Shift+R）
2. ブラウザのキャッシュをクリア
3. シークレットモード/プライベートブラウジングで確認

---

## 📄 関連ファイル

- **js/config.js**: 集計設定（除外ルール、キーワード、閾値）
- **index.html**: ダッシュボードUI + チャートロジック
- **register.html**: 診療科マスタ管理 + オートコンプリート

---

## 📞 サポート

ご不明な点や追加機能のご要望がございましたら、お気軽にお問い合わせください。

**開発チーム**: Seed Planning Research Team  
**最終更新**: 2025-12-25
