<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Debug Test</title>
  <link rel="icon" type="image/png" href="SP_logo_shape_only.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/style-2026.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="js/utils.js"></script>
  <script src="js/data/specialties-master.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-8">
    <h1 class="text-2xl font-bold mb-6">Register.html デバッグテスト</h1>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">1. 基本的なチェック</h2>
      <div id="basic-check" class="space-y-2 text-sm"></div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">2. 実際のフォーム（register.htmlと同じ構造）</h2>
      
      <div class="relative" id="specialty-combobox">
        <label for="specialtyInput" class="block text-sm font-medium text-gray-700 mb-2">
          <i class="fas fa-user-md mr-2 text-indigo-600"></i>
          専門（診療科）
        </label>

        <input
          id="specialtyInput"
          name="specialty"
          type="text"
          autocomplete="off"
          role="combobox"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-controls="specialtyList"
          aria-activedescendant=""
          placeholder="先頭2〜3文字で候補表示（例：消化 / 循環 / 皮膚…）"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
        />
        
        <ul id="specialtyList" role="listbox" 
            class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto">
        </ul>
        
        <span id="specialtyError" class="hidden text-sm text-red-600"></span>
        
        <!-- Hidden fields (register.htmlと同じ) -->
        <input type="hidden" id="specialtyCode" name="specialty_code">
        <input type="hidden" id="specialtyEn"   name="specialty_en">
      </div>
      
      <div class="mt-4 p-4 bg-gray-100 rounded">
        <p class="text-sm font-medium mb-2">選択結果:</p>
        <div id="result">
          <div>Code: <span id="show-code">-</span></div>
          <div>日本語: <span id="show-ja">-</span></div>
          <div>英語: <span id="show-en">-</span></div>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold mb-4">3. コンソール出力</h2>
      <pre id="console-output" class="text-xs bg-gray-900 text-gray-300 p-4 rounded overflow-x-auto max-h-96 overflow-y-auto"></pre>
    </div>
  </div>

  <!-- register.htmlと同じスクリプト構造 -->
  <script>
    // コンソール出力をキャプチャ
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    const originalError = console.error;
    let logBuffer = [];
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      const msg = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      logBuffer.push('[LOG] ' + msg);
      if (consoleOutput) {
        consoleOutput.textContent = logBuffer.join('\n');
      }
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      const msg = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      logBuffer.push('[ERROR] ' + msg);
      if (consoleOutput) {
        consoleOutput.textContent = logBuffer.join('\n');
      }
    };
    
    // グローバルスコープで変数と関数を定義（register.htmlと同じ）
    let SPECIALTIES_MASTER = [];
    let SPECIALTIES_INDEX = [];
    let SPECIALTY_ALIASES = {};
    
    // 正規化関数もグローバルスコープに定義
    const normalizeKey = (s) => (s || "").toString().trim().toLowerCase()
                 .replace(/\s+/g, "").normalize("NFKC");
    
    // DOMContentLoadedを待ってから実行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOMContentLoaded ===');
      
      // 基本チェック
      const basicCheck = document.getElementById('basic-check');
      const checks = [
        { name: 'SpecialtyMaster', result: typeof SpecialtyMaster !== 'undefined' },
        { name: 'normalizeKey', result: typeof normalizeKey === 'function' },
        { name: 'specialtyInput', result: !!document.getElementById('specialtyInput') },
        { name: 'specialtyList', result: !!document.getElementById('specialtyList') },
        { name: 'specialtyCode', result: !!document.getElementById('specialtyCode') },
        { name: 'specialtyEn', result: !!document.getElementById('specialtyEn') },
      ];
      
      basicCheck.innerHTML = checks.map(c => 
        `<div class="${c.result ? 'text-green-600' : 'text-red-600'}">
          ${c.result ? '✓' : '✗'} ${c.name}: ${c.result ? 'OK' : 'NG'}
        </div>`
      ).join('');
      
      if (typeof SpecialtyMaster === 'undefined') {
        console.error('SpecialtyMaster is not loaded!');
        return;
      }
      
      // 後方互換性のため、既存の変数名にマッピング
      SPECIALTIES_MASTER = SpecialtyMaster.getAllSpecialties().map(s => ({
        code: s.code,
        ja: s.ja,
        en: s.en
      }));
      
      console.log('SPECIALTIES_MASTER loaded:', SPECIALTIES_MASTER.length);
      
      // 検索インデックスを作成
      SPECIALTIES_INDEX = [];
      
      const allSpecialties = SpecialtyMaster.getAllSpecialties();
      allSpecialties.forEach(r => {
        SPECIALTIES_INDEX.push({
          code: r.code,
          ja: r.ja,
          en: r.en || '',
          key_ja: normalizeKey(r.ja),
          key_en: normalizeKey(r.en || ''),
          key_code: normalizeKey(r.code),
        });
      });
      
      console.log('SPECIALTIES_INDEX created:', SPECIALTIES_INDEX.length);
      
      // UI ロジック（register.htmlと同じ）
      const input = document.getElementById("specialtyInput");
      const list  = document.getElementById("specialtyList");
      const err   = document.getElementById("specialtyError");
      const hidCode = document.getElementById("specialtyCode");
      const hidEn   = document.getElementById("specialtyEn");
      
      if (!input || !list) {
        console.error('Required elements not found!');
        return;
      }
      
      let currentItems = [];
      
      function hideError() {
        err.classList.add("hidden");
        input.classList.remove("border-red-400", "focus:ring-red-500");
      }
      
      function hideList() {
        list.classList.add("hidden");
      }
      
      function renderList(items) {
        console.log('renderList called with', items.length, 'items');
        list.innerHTML = "";
        currentItems = items;

        if (!items.length) {
          hideList(); 
          return;
        }
        
        items.forEach((r, idx) => {
          const li = document.createElement("li");
          li.className = "px-3 py-2 cursor-pointer hover:bg-indigo-50 text-sm";
          li.innerHTML = `<span class="font-medium">${r.ja}</span>
                          <span class="text-gray-500 ml-2">(${r.en})</span>
                          <span class="text-gray-400 ml-2 text-xs">#${r.code}</span>`;
          li.addEventListener("click", () => {
            input.value = r.ja;
            hidCode.value = r.code;
            hidEn.value = r.en;
            
            // 結果表示を更新
            document.getElementById('show-code').textContent = r.code;
            document.getElementById('show-ja').textContent = r.ja;
            document.getElementById('show-en').textContent = r.en;
            
            console.log('Selected:', r);
            hideList();
          });
          list.appendChild(li);
        });
        list.classList.remove("hidden");
      }
      
      function candidates(qRaw) {
        if (!qRaw) return [];
        
        console.log('Searching for:', qRaw);
        let q = normalizeKey(qRaw);

        const starts = [];
        const parts  = [];
        
        for (const r of SPECIALTIES_INDEX) {
          const hitStart = r.key_ja.startsWith(q) || r.key_en.startsWith(q) || r.key_code.startsWith(q);
          const hitPart  = !hitStart && (r.key_ja.includes(q) || r.key_en.includes(q) || r.key_code.includes(q));
          if (hitStart) starts.push(r);
          else if (hitPart) parts.push(r);
        }
        
        const results = [...starts, ...parts].slice(0, 30);
        console.log('Found', results.length, 'candidates');
        return results;
      }
      
      input.addEventListener("input", () => {
        console.log('Input event, value:', input.value);
        hideError();
        const items = candidates(input.value);
        renderList(items);
      });
      
      // クリックアウトで閉じる
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#specialty-combobox')) {
          hideList();
        }
      });
      
      console.log('Setup complete!');
    });
  </script>
</body>
</html>