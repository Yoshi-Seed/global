# 重複プロジェクト表示問題 - 根本原因と修正完了

## 🎯 問題の根本原因が判明しました！

コンソールログの分析により、根本原因を特定しました：

### 発見した事実
スクリーンショットのコンソールログ:
```
Loaded 611 projects from GitHub
```

しかし、CSVファイルには **469レコード** しかありません（ヘッダー除く）。

**差分: 611 - 469 = 142件の偽レコード**

## 🔴 根本原因: CSVパーサーの致命的な欠陥

### 問題のあったコード (`js/api.js` line 73)

```javascript
parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);  // ❌ すべての改行で分割
  // ...
}
```

### なぜ問題だったのか

1. **`split(/\r?\n/)` はすべての改行で分割する**
   - 引用符の内側・外側を区別しない
   - CSVフィールド内の改行も「行の区切り」として扱ってしまう

2. **CSVの「対象条件」フィールドに複数行のテキストが含まれている**
   - 例: 
     ```
     "糖尿病と診断されていない肥満症の成人患者を
     月に30名以上診察または治療している。"
     ```
   - このフィールドが2行に分割される

3. **結果として1つのレコードが複数のレコードに分割される**
   - 469レコード → 611「行」に分割
   - 同じID（例: 424, 425, 426）が複数の「行」として扱われる
   - UI上で同じプロジェクトが5回表示される

### 具体例

**CSVの実際のデータ**:
```csv
"424","20251105-0005","肥満症","Obesity","IDI","定性","医師","循環器内科","3","FALSE","糖尿病と診断されていない肥満症の成人患者を
月に30名以上診察または治療している。","オルフォグリプロン","キャンドゥ","国吉尚子",...
```

**誤ったパース結果** (split で分割):
```javascript
// 行1
["424","20251105-0005","肥満症",...,"糖尿病と診断されていない肥満症の成人患者を"]

// 行2（偽のレコード）
["月に30名以上診察または治療している。","オルフォグリプロン",...]
```

↓

**UI表示の問題**:
- 行1: No.424として表示（ID=424）
- 行2: 不完全なデータだが、ID列がないので `index + 1` で ID が生成される
- 複数の不完全なレコードが同じIDで生成される
- 結果: 同じプロジェクトが複数回表示される

## ✅ 実装した修正

### 新しいCSVパーサー (`js/api.js`)

```javascript
/**
 * CSVテキストをパース（引用符内の改行に対応）
 */
parseCSV(csvText) {
  const text = csvText.trim();
  const rows = [];
  let currentRow = '';
  let inQuotes = false;
  
  // 文字列を1文字ずつ処理して、引用符内の改行を考慮
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];
    
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        // エスケープされた引用符 ("")
        currentRow += '""';
        i++; // 次の文字をスキップ
      } else {
        // 引用符の開始/終了
        inQuotes = !inQuotes;
        currentRow += char;
      }
    } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
      // 引用符外の改行 = 行の区切り
      if (currentRow.trim()) {
        rows.push(currentRow.trim());
      }
      currentRow = '';
      if (char === '\r') i++; // CRLF の場合、\n もスキップ
    } else {
      currentRow += char;
    }
  }
  
  // 最後の行を追加
  if (currentRow.trim()) {
    rows.push(currentRow.trim());
  }
  
  console.log(`📝 CSV parsing: ${rows.length} total rows (including header), ${rows.length - 1} data rows`);
  
  // ヘッダー行をスキップして、各行をパース
  return rows.slice(1).map((row, index) => {
    const fields = this.parseCSVLine(row);
    // ... プロジェクトオブジェクトを生成
  }).filter(project => project.diseaseName);
}
```

### 修正のポイント

1. **引用符の状態を追跡**: `inQuotes` フラグで現在位置が引用符内かどうかを管理
2. **引用符外の改行のみで分割**: `!inQuotes` の時だけ行を区切る
3. **引用符内の改行は保持**: フィールドの一部として維持
4. **CRLF/LF両対応**: Windows (`\r\n`) と Unix (`\n`) の両方の改行コードに対応
5. **エスケープ処理**: `""` を正しく1つの引用符として処理
6. **デバッグログ追加**: パース結果の行数をコンソールに出力

## 📊 検証方法

### 修正前のコンソールログ
```
Fetching data from GitHub via Worker...
Loaded 611 projects from GitHub          ❌ 間違い！142件の偽レコード
Using cached data
```

### 修正後のコンソールログ（期待値）
```
📝 CSV parsing: 470 total rows (including header), 469 data rows
Fetching data from GitHub via Worker...
Loaded 469 projects from GitHub          ✅ 正しい！
📊 Total projects loaded: 469
✅ データに重複なし
```

### UI表示の確認

**修正前**:
- No.426 が5回表示
- No.425 が5回表示
- No.424 が5回表示
- 合計表示数が不正確

**修正後**:
- ✅ No.426 が1回だけ表示
- ✅ No.425 が1回だけ表示
- ✅ No.424 が1回だけ表示
- ✅ 合計469プロジェクト（正確）

## 🧪 テスト手順

1. **ブラウザでページを開く**
   ```
   https://your-domain/projects.html
   ```

2. **スーパーリロード** (キャッシュをクリア)
   - Windows/Linux: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

3. **コンソールを開く** (`F12` キー)
   - Console タブを選択

4. **以下のログを確認**:
   ```
   📝 CSV parsing: 470 total rows (including header), 469 data rows
   Fetching data from GitHub via Worker...
   Loaded 469 projects from GitHub
   📊 Total projects loaded: 469
   ✅ データに重複なし
   ```

5. **UI表示を確認**:
   - プロジェクト一覧で No.426, 425, 424 が1回ずつしか表示されないこと
   - ページネーション: 5ページ（100件/ページ × 4 + 69件）
   - 合計469プロジェクト

## 📈 影響範囲

### データの正確性
| 項目 | 修正前 | 修正後 | 差分 |
|------|--------|--------|------|
| 読み込みプロジェクト数 | 611 | 469 | -142 (偽レコード削除) |
| 重複レコード | 142件 | 0件 | -142 |
| データ正確性 | ❌ 不正確 | ✅ 正確 | - |

### ページネーション
| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| 総ページ数 | 7ページ | 5ページ |
| 最後のページ | 11件 | 69件 |
| 件数表示 | 不正確 | 正確 |

### パフォーマンス
- **メモリ使用量**: 約23%削減（611 → 469レコード）
- **レンダリング時間**: 改善（不要なレコードがない）
- **検索速度**: 改善（配列サイズが小さい）

## 📁 変更ファイル

- `js/api.js` - CSVパーサーの完全書き換え
  - 行数: +44, -7
  - 機能: 引用符内改行対応の完全なCSVパーサー実装

## 🔗 関連情報

### Pull Requests
- **PR #168**: デバッグコードと調査レポート（マージ済み）
- **PR #169**: 根本原因修正（このPR）

### Commits
- `ca412d7`: デバッグロジック追加
- `c7e87be`: 調査レポート作成
- `360134b`: CSVパーサー修正（根本原因解決）

### ドキュメント
- `DUPLICATE_PROJECTS_ISSUE_REPORT.md`: 詳細な調査レポート
- `CSV_PARSER_FIX_SUMMARY.md`: この修正のサマリー（本ドキュメント）

## 🎓 学んだこと

### CSVパースの落とし穴

1. **単純な `split()` は危険**
   - CSVは見た目よりも複雑なフォーマット
   - 引用符、エスケープ、改行の扱いが重要

2. **RFC 4180準拠が推奨**
   - CSV形式の標準仕様
   - 引用符内の改行、カンマ、引用符のエスケープを定義

3. **ライブラリの使用を検討**
   - PapaParse など、実績のあるCSVパーサー
   - ただし、今回は軽量化のため自前実装

### デバッグの重要性

1. **コンソールログが問題を明確化**
   - "611 projects" という数値が決定的な証拠
   - データ量の不一致を即座に発見

2. **段階的な調査が有効**
   - CSV ファイル確認 → API コード確認 → ログ分析
   - 各段階で仮説を検証

3. **再現可能なテストケース**
   - 特定のレコード（No.426, 425, 424）で問題が顕著
   - デバッグとテストがしやすい

## 🚀 今後の改善案

### 短期的な改善
1. ✅ **CSVパーサーのユニットテスト追加**
   - 引用符内改行のテストケース
   - エッジケースのカバレッジ

2. ✅ **パフォーマンス最適化**
   - 大量データ（数千行）でのベンチマーク
   - 必要に応じてストリーミングパース

### 長期的な改善
1. **PapaParseなどのライブラリ導入検討**
   - より堅牢なCSVパース
   - RFC 4180完全準拠

2. **API側でのバリデーション強化**
   - CSVの形式チェック
   - 不正なデータの早期検出

3. **エラーハンドリング改善**
   - パースエラー時の適切なフィードバック
   - ユーザーへのエラーメッセージ

## 📞 サポート

### 問題が解決しない場合

1. **キャッシュをクリア**
   - ブラウザのハードリロード（Ctrl+Shift+R）
   - Cloudflare Worker のキャッシュクリア（5分待つ）

2. **コンソールログを確認**
   - 期待値と異なるログがないか確認
   - エラーメッセージをチェック

3. **GitHub Issue作成**
   - コンソールログのスクリーンショット添付
   - 再現手順の記載

---

## ✅ 完了チェックリスト

- [x] 根本原因の特定
- [x] CSVパーサーの修正実装
- [x] デバッグログの追加
- [x] コミットとプッシュ
- [x] Pull Request 作成（#169）
- [x] ドキュメント作成
- [ ] ユーザーによる動作確認
- [ ] PR マージ
- [ ] 本番デプロイ

---

**作成日**: 2025-11-09  
**作成者**: Claude Code (AI Assistant)  
**ステータス**: ✅ 修正完了、ユーザー確認待ち  
**Pull Request**: https://github.com/Yoshi-Seed/global/pull/169
