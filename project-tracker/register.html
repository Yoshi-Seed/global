<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新規プロジェクト登録 - プロジェクト履歴管理システム</title>
  <link rel="icon" type="image/png" href="SP_logo_shape%20only.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <!-- ナビゲーション -->
  <nav class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="Seed_Planning_Logo_Original.jpg" alt="SEED PLANNING" class="h-10">
          <h1 class="text-lg font-bold text-gray-800">プロジェクト履歴管理システム</h1>
        </div>
        <div class="flex space-x-3">
          <a href="index.html" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            <i class="fas fa-home mr-2"></i>ダッシュボード
          </a>
          <a href="register.html" class="px-4 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
            <i class="fas fa-plus mr-2"></i>新規登録
          </a>
          <a href="projects.html" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            <i class="fas fa-search mr-2"></i>案件検索
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツ -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      
      <!-- ヘッダー -->
      <div class="rounded-lg shadow-md p-6 mb-6" style="background: linear-gradient(135deg, #E8F0F1 0%, #d5e5e7 100%);">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-plus-circle mr-3 text-green-600"></i>
          新規案件登録
        </h2>
        <p class="text-gray-600 mt-2">リクルート済案件の実績情報を入力してください。1つのプロジェクトで複数のターゲットがあった場合はターゲットごとに入力を繰り返してください。</p>
      </div>

      <!-- 登録フォーム -->
      <form id="projectForm" class="bg-white rounded-lg shadow-md p-6 space-y-6">
        
        <!-- 疾患名 -->
        <div>
          <label for="diseaseName" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-heartbeat mr-2 text-red-600"></i>
            疾患名 <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="diseaseName" 
            name="diseaseName" 
            required
            placeholder="例: アルツハイマー型認知症"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
        </div>

        <!-- 疾患略語 -->
        <div>
          <label for="diseaseAbbr" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-tag mr-2 text-purple-600"></i>
            疾患略語
          </label>
          <input 
            type="text" 
            id="diseaseAbbr" 
            name="diseaseAbbr" 
            placeholder="例: AD, T2DM, COPD"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
        </div>

        <!-- 2列レイアウト -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- 手法 -->
          <div>
            <label for="method" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-clipboard-list mr-2 text-blue-600"></i>
              手法 <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="method" 
              name="method" 
              required
              placeholder="例: IDI, アンケート, 会場調査"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- 調査種別 -->
          <div>
            <label for="surveyType" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-chart-bar mr-2 text-green-600"></i>
              調査種別 <span class="text-red-500">*</span>
            </label>
            <select 
              id="surveyType" 
              name="surveyType" 
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="定性" selected>定性</option>
              <option value="定量">定量</option>
              <option value="その他">その他</option>
            </select>
          </div>
        </div>

        <!-- 対象者種別 -->
        <div>
          <label for="targetType" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-users mr-2 text-green-600"></i>
            対象者種別 <span class="text-red-500">*</span>
          </label>
          <select 
            id="targetType" 
            name="targetType" 
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">選択してください</option>
            <option value="医師">医師</option>
            <option value="患者">患者</option>
            <option value="介護者">介護者</option>
            <option value="医師・患者">医師・患者</option>
            <option value="KOL">KOL</option>
            <option value="看護師">看護師</option>
            <option value="薬剤師">薬剤師</option>
          </select>
        </div>

        <!-- 専門（コンボボックス） -->
        <div class="relative" id="specialty-combobox">
          <label for="specialtyInput" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-md mr-2 text-indigo-600"></i>
            専門（診療科）
          </label>

          <input
            id="specialtyInput"
            name="specialty"
            type="text"
            autocomplete="off"
            role="combobox"
            aria-autocomplete="list"
            aria-expanded="false"
            aria-controls="specialtyList"
            aria-activedescendant=""
            placeholder="先頭2〜3文字で候補表示（例：消化 / 循環 / 皮膚…）"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />

          <!-- 候補ドロップダウン -->
          <ul
            id="specialtyList"
            role="listbox"
            class="absolute z-10 w-full mt-1 border border-gray-200 bg-white rounded-md shadow hidden max-h-56 overflow-auto"
          ></ul>

          <!-- 送信用の正規化データ（将来の拡張用） -->
          <input type="hidden" id="specialtyCode" name="specialty_code">
          <input type="hidden" id="specialtyEn"   name="specialty_en">

          <p class="text-xs text-gray-500 mt-1">候補から選択してください。対象者が医師の場合のみ入力（任意）</p>
          <p id="specialtyError" class="mt-2 text-sm text-red-600 hidden">候補の中から選んでください。</p>
        </div>

        <!-- 実績数 -->
        <div>
          <label for="recruitCount" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-plus mr-2 text-purple-600"></i>
            実績数（リクルート人数） <span class="text-red-500">*</span>
          </label>
          <input 
            type="number" 
            id="recruitCount" 
            name="recruitCount" 
            required
            min="1"
            placeholder="例: 50"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
          
          <!-- 問合せのみチェックボックス -->
          <div class="mt-3 flex items-center">
            <input 
              type="checkbox" 
              id="inquiryOnly" 
              name="inquiryOnly" 
              class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2"
            >
            <label for="inquiryOnly" class="ml-2 text-sm font-medium text-gray-700">
              問合せのみ（推定回収数として記録）
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">※実際のリクルートではなく、問合せ確認数の場合はチェックしてください</p>
        </div>

        <!-- 対象条件 -->
        <div>
          <label for="targetConditions" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-filter mr-2 text-orange-600"></i>
            対象条件（スクリーニング条件） <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="targetConditions" 
            name="targetConditions" 
            rows="3"
            required
            placeholder="例: アルツハイマー型認知症患者を月に20人以上診療"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">リクルート対象の詳細条件を入力してください</p>
        </div>

        <!-- 薬剤 -->
        <div>
          <label for="drug" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-pills mr-2 text-pink-600"></i>
            薬剤（任意）
          </label>
          <input 
            type="text" 
            id="drug" 
            name="drug" 
            placeholder="例: レカネマブ, レケンビ"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
          <p class="text-xs text-gray-500 mt-1">調査対象の薬剤名を入力してください（複数の場合はカンマ区切り）</p>
        </div>

        <!-- 2列レイアウト -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- リクルート実施会社 -->
          <div>
            <label for="recruitCompany" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-building mr-2 text-teal-600"></i>
              リクルート実施（問合せ先）
            </label>
            <input 
              type="text" 
              id="recruitCompany" 
              name="recruitCompany" 
              placeholder="例: キャンドゥ, アスマーク"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- クライアント -->
          <div>
            <label for="client" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-handshake mr-2 text-yellow-600"></i>
              クライアント
            </label>
            <input 
              type="text" 
              id="client" 
              name="client" 
              placeholder="例: The Link Group"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <!-- 新規追加項目 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- モデレーター -->
          <div>
            <label for="moderator" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-user-tie mr-2 text-purple-600"></i>
              モデレーター（任意）
            </label>
            <input 
              type="text" 
              id="moderator" 
              name="moderator" 
              placeholder="例: 山本駿人"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- エンドクライアント -->
          <div>
            <label for="endClient" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-building mr-2 text-blue-600"></i>
              エンドクライアント（任意）
            </label>
            <input 
              type="text" 
              id="endClient" 
              name="endClient" 
              placeholder="例: エーザイ"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- PJ番号 -->
          <div>
            <label for="projectNumber" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-hashtag mr-2 text-indigo-600"></i>
              PJ番号（任意）
            </label>
            <input 
              type="text" 
              id="projectNumber" 
              name="projectNumber" 
              placeholder="例: Y10034163"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- 実施年月 -->
          <div>
            <label for="implementationDate" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-calendar mr-2 text-red-600"></i>
              実施年月（問合せ年月）
            </label>
            <input 
              type="text" 
              id="implementationDate" 
              name="implementationDate" 
              placeholder="例: 2024/11"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
            <p class="text-xs text-gray-500 mt-1">YYYY/MM形式で入力</p>
          </div>

          <!-- 登録担当 -->
          <div>
            <label for="registrant" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-user-check mr-2 text-teal-600"></i>
              登録担当
            </label>
            <input 
              type="text" 
              id="registrant" 
              name="registrant" 
              placeholder="例: 末田"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <!-- 登録メッセージ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700 text-center">
            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
            案件登録ありがとうございます。以下のボタンからPR(登録)を実行してください。
          </p>
        </div>

        <!-- 送信ボタン -->
        <div class="flex space-x-4 pt-4">
          <button 
            type="submit" 
            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center space-x-2"
          >
            <i class="fas fa-code-branch"></i>
            <span>この内容でPRを作る</span>
          </button>
          <button 
            type="button" 
            onclick="resetForm()" 
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
          >
            <i class="fas fa-redo mr-2"></i>
            リセット
          </button>
        </div>
      </form>

      <!-- 成功メッセージ -->
      <div id="successMessage" class="hidden mt-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle text-xl"></i>
            <span class="font-semibold">PRを作成しました！</span>
          </div>
          <button onclick="hideSuccessMessage()" class="text-green-700 hover:text-green-900">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="prLinkContainer" class="ml-7">
          <a id="prLink" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 underline flex items-center space-x-2">
            <i class="fab fa-github"></i>
            <span>GitHubでPRを確認する</span>
            <i class="fas fa-external-link-alt text-sm"></i>
          </a>
        </div>
      </div>

      <!-- エラーメッセージ -->
      <div id="errorMessage" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <i class="fas fa-exclamation-circle text-xl"></i>
          <span id="errorText">エラーが発生しました</span>
        </div>
        <button onclick="hideErrorMessage()" class="text-red-700 hover:text-red-900">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 共通設定 -->
  <script src="js/config.js"></script>

  <!-- 専門フィールド オートコンプリート -->
  <script>
    // ---- 1) 正式マスタ（診療科一覧） ----
    const SPECIALTIES_MASTER = [
      { code: "リウマチ科", ja: "リウマチ科", en: "Rheumatology" },
      { code: "100", ja: "小児科", en: "Pediatrics" },
      { code: "110", ja: "外科", en: "Surgery" },
      { code: "120", ja: "整形外科", en: "Orthopaedic Surgery" },
      { code: "130", ja: "形成外科", en: "Plastic Surgery" },
      { code: "140", ja: "美容外科", en: "Cosmetic Surgery" },
      { code: "150", ja: "脳神経外科", en: "Neurosurgery" },
      { code: "160", ja: "呼吸器外科", en: "Thoracic Surgery" },
      { code: "170", ja: "心臓血管外科", en: "Cardiovascular Surgery" },
      { code: "180", ja: "小児外科", en: "Pediatric Surgery" },
      { code: "190", ja: "皮膚泌尿器科", en: "Dermatology & Urology" },
      { code: "200", ja: "性病科", en: "Sexually Transmitted Disease Medicine" },
      { code: "210", ja: "肛門科", en: "Proctology" },
      { code: "220", ja: "産婦人科", en: "Obstetrics & Gynecology" },
      { code: "230", ja: "眼科", en: "Ophthalmology" },
      { code: "240", ja: "耳鼻咽喉科", en: "Otorhinolaryngology (ENT)" },
      { code: "250", ja: "気管食道科", en: "Tracheo-Esophageal Medicine" },
      { code: "260", ja: "リハビリテーション科", en: "Rehabilitation Medicine" },
      { code: "270", ja: "放射線科", en: "Radiology" },
      { code: "280", ja: "神経内科", en: "Neurology (Internal)" },
      { code: "290", ja: "胃腸科", en: "Gastroenterology" },
      { code: "300", ja: "皮膚科", en: "Dermatology" },
      { code: "310", ja: "泌尿器科", en: "Urology" },
      { code: "320", ja: "産科", en: "Obstetrics" },
      { code: "330", ja: "婦人科", en: "Gynecology" },
      { code: "340", ja: "呼吸器内科", en: "Respiratory Medicine (Internal)" },
      { code: "350", ja: "循環器内科", en: "Cardiovascular Medicine (Internal)" },
      { code: "400", ja: "糖尿病科", en: "Diabetology" },
      { code: "410", ja: "腎臓内科", en: "Nephrology" },
      { code: "420", ja: "腎移植科", en: "Kidney Transplantation" },
      { code: "430", ja: "血液透析科", en: "Dialysis Medicine" },
      { code: "440", ja: "代謝内科", en: "Metabolic Medicine" },
      { code: "450", ja: "内分泌内科", en: "Endocrinology" },
      { code: "460", ja: "救急医学科", en: "Emergency Medicine" },
      { code: "470", ja: "血液科", en: "Hematology" },
      { code: "480", ja: "血液内科", en: "Hematology (Internal)" },
      { code: "490", ja: "麻酔科", en: "Anesthesiology" },
      { code: "500", ja: "消化器内科", en: "Gastroenterology (Internal)" },
      { code: "510", ja: "消化器外科", en: "Gastroenterological Surgery" },
      { code: "540", ja: "大腸肛門科", en: "Colorectal Surgery" },
      { code: "590", ja: "腫瘍治療科", en: "Oncology (Treatment)" },
      { code: "600", ja: "総合診療科", en: "General Practice" },
      { code: "610", ja: "乳腺甲状腺外科", en: "Breast & Thyroid Surgery" },
      { code: "620", ja: "新生児科", en: "Neonatology" },
      { code: "630", ja: "小児循環器科", en: "Pediatric Cardiology" },
    ];

    // ---- 2) よくある表記の「別名 → 正式名」マップ ----
    const SPECIALTY_ALIASES = {
      "消化器科": "消化器内科",
      "消化器": "消化器内科",
      "GI": "消化器内科",
      "循環器科": "循環器内科",
      "呼吸器科": "呼吸器内科",
      "血液": "血液内科",
      "脳外": "脳神経外科",
      "耳鼻科": "耳鼻咽喉科",
      "整形": "整形外科",
      "形成": "形成外科",
      "麻酔": "麻酔科",
      "小児循環器": "小児循環器科",
      "皮泌": "皮膚泌尿器科",
      "内分泌科": "内分泌内科",
      "代謝科": "代謝内科",
      "腎臓科": "腎臓内科",
      "血液透析": "血液透析科",
      "総合診療": "総合診療科",
    };

    // ---- 3) 正規化関数 ----
    const normalizeKey = (s) => (s || "").toString().trim().toLowerCase()
                 .replace(/\s+/g, "").normalize("NFKC");

    // 検索キーを増やす（日本語・英名・コード）
    const SPECIALTIES_INDEX = SPECIALTIES_MASTER.map(r => ({
      ...r,
      key_ja: normalizeKey(r.ja),
      key_en: normalizeKey(r.en),
      key_code: normalizeKey(r.code),
    }));

    // ---- 4) UI ロジック ----
    (function setupSpecialtyCombobox() {
      const input = document.getElementById("specialtyInput");
      const list  = document.getElementById("specialtyList");
      const err   = document.getElementById("specialtyError");
      const hidCode = document.getElementById("specialtyCode");
      const hidEn   = document.getElementById("specialtyEn");

      let activeIndex = -1;
      let currentItems = [];

      function showError(msg = "候補の中から選んでください。") {
        err.textContent = msg;
        err.classList.remove("hidden");
        input.classList.add("border-red-400", "focus:ring-red-500");
      }
      function hideError() {
        err.classList.add("hidden");
        input.classList.remove("border-red-400", "focus:ring-red-500");
      }
      function hideList() {
        list.classList.add("hidden");
        input.setAttribute("aria-expanded", "false");
        input.setAttribute("aria-activedescendant", "");
      }

      function renderList(items) {
        list.innerHTML = "";
        activeIndex = -1;
        currentItems = items;

        if (!items.length) {
          hideList(); return;
        }
        items.forEach((r, idx) => {
          const li = document.createElement("li");
          li.id = `specialty-opt-${idx}`;
          li.setAttribute("role", "option");
          li.className = "px-3 py-2 cursor-pointer hover:bg-indigo-50 text-sm";
          li.innerHTML = `<span class="font-medium">${r.ja}</span>
                          <span class="text-gray-500 ml-2">(${r.en})</span>
                          <span class="text-gray-400 ml-2 text-xs">#${r.code}</span>`;
          li.addEventListener("mousedown", (e) => { e.preventDefault(); choose(idx); });
          list.appendChild(li);
        });
        list.classList.remove("hidden");
        input.setAttribute("aria-expanded", "true");
      }

      function choose(idx) {
        const r = currentItems[idx];
        if (!r) return;
        input.value = r.ja;
        hidCode.value = r.code;
        hidEn.value   = r.en;
        hideError(); hideList();
      }

      // 入力 → 候補生成
      function candidates(qRaw) {
        if (!qRaw) return [];
        let q = normalizeKey(qRaw);
        // 別名 → 正式名に寄せる
        if (SPECIALTY_ALIASES[qRaw]) q = normalizeKey(SPECIALTY_ALIASES[qRaw]);

        // 先頭一致を最優先、次に部分一致
        const starts = [];
        const parts  = [];
        for (const r of SPECIALTIES_INDEX) {
          const hitStart = r.key_ja.startsWith(q) || r.key_en.startsWith(q) || r.key_code.startsWith(q);
          const hitPart  = !hitStart && (r.key_ja.includes(q) || r.key_en.includes(q) || r.key_code.includes(q));
          if (hitStart) starts.push(r);
          else if (hitPart) parts.push(r);
        }
        return [...starts, ...parts].slice(0, 30);
      }

      input.addEventListener("input", () => {
        hideError();
        const items = candidates(input.value);
        // 選択が外れたら hidden をクリア
        hidCode.value = ""; hidEn.value = "";
        renderList(items);
      });

      input.addEventListener("keydown", (e) => {
        const visible = !list.classList.contains("hidden");
        if (!visible && ["ArrowDown", "ArrowUp"].includes(e.key)) {
          renderList(candidates(input.value));
        }
        if (e.key === "ArrowDown" && visible) {
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, currentItems.length - 1);
          highlight();
        } else if (e.key === "ArrowUp" && visible) {
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, 0);
          highlight();
        } else if (e.key === "Enter" && visible) {
          e.preventDefault(); choose(activeIndex >= 0 ? activeIndex : 0);
        } else if (e.key === "Escape") {
          hideList();
        }
      });

      function highlight() {
        [...list.children].forEach((li, i) => {
          if (i === activeIndex) {
            li.classList.add("bg-indigo-50");
            input.setAttribute("aria-activedescendant", li.id);
            li.scrollIntoView({ block: "nearest" });
          } else {
            li.classList.remove("bg-indigo-50");
          }
        });
      }

      input.addEventListener("blur", () => setTimeout(hideList, 120));

      // 送信時：入力があればマスタに存在するものだけ通す（空欄はOK）
      const form = input.closest("form");
      if (form) {
        form.addEventListener("submit", (e) => {
          const v = input.value.trim();
          
          // 空欄は許可（任意項目なので）
          if (!v) {
            hidCode.value = "";
            hidEn.value = "";
            hideError();
            return;
          }

          const key = normalizeKey(v);
          // 別名補正
          const alias = SPECIALTY_ALIASES[v] || SPECIALTY_ALIASES[key];
          const targetLabel = alias || v;

          // マスタ検索（日本語完全一致）
          const hit = SPECIALTIES_MASTER.find(r => r.ja === targetLabel);
          if (!hit) {
            e.preventDefault();
            e.stopPropagation();
            renderList(candidates(v));
            showError("候補の中から選んでください（英名やコードでも検索できます）。");
            hidCode.value = ""; hidEn.value = "";
            input.focus();
            return;
          }
          // 正式名＆コード・英名で送る
          input.value   = hit.ja;
          hidCode.value = hit.code;
          hidEn.value   = hit.en;
          hideError();
        });
      }
    })();
  </script>

  <!-- フォームロジック -->
  <script>
    // Cloudflare Worker API エンドポイント（config.jsから取得）
    const API_ENDPOINT = API.getSubmitUrl();

    // フォーム送信
    document.getElementById('projectForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // 送信ボタンを無効化
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>送信中...</span>';

      // フォームデータを収集
      const formData = {
        diseaseName: document.getElementById('diseaseName').value.trim(),
        diseaseAbbr: document.getElementById('diseaseAbbr').value.trim(),
        method: document.getElementById('method').value.trim(),
        surveyType: document.getElementById('surveyType').value.trim(),
        targetType: document.getElementById('targetType').value,
        specialty: document.getElementById('specialtyInput').value.trim(),
        recruitCount: parseInt(document.getElementById('recruitCount').value) || 0,
        inquiryOnly: document.getElementById('inquiryOnly').checked,
        targetConditions: document.getElementById('targetConditions').value.trim(),
        drug: document.getElementById('drug').value.trim(),
        recruitCompany: document.getElementById('recruitCompany').value.trim(),
        moderator: document.getElementById('moderator').value.trim(),
        client: document.getElementById('client').value.trim(),
        endClient: document.getElementById('endClient').value.trim(),
        projectNumber: document.getElementById('projectNumber').value.trim(),
        implementationDate: document.getElementById('implementationDate').value.trim(),
        registrant: document.getElementById('registrant').value.trim()
      };

      try {
        // API にPOSTリクエスト
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // 成功: PRリンクを表示
          showSuccessMessage(result.prUrl);
          
          // フォームをリセット
          setTimeout(() => {
            resetForm();
          }, 1000);
        } else {
          // エラー: バリデーションエラーを表示
          if (result.details) {
            showValidationErrors(result.details);
          } else {
            showErrorMessage(result.message || 'エラーが発生しました');
          }
        }
      } catch (error) {
        console.error('API Error:', error);
        showErrorMessage('通信エラーが発生しました: ' + error.message);
      } finally {
        // 送信ボタンを再度有効化
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      }
    });

    // フォームをリセット
    function resetForm() {
      document.getElementById('projectForm').reset();
      // バリデーションエラー表示をクリア
      document.querySelectorAll('.error-text').forEach(el => el.remove());
      document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
      });
    }

    // 成功メッセージ表示（PRリンク付き）
    function showSuccessMessage(prUrl) {
      const element = document.getElementById('successMessage');
      const prLink = document.getElementById('prLink');
      
      prLink.href = prUrl;
      element.classList.remove('hidden');
      
      // 自動的に非表示にしない（ユーザーが確認するまで表示）
    }

    function hideSuccessMessage() {
      document.getElementById('successMessage').classList.add('hidden');
    }

    // バリデーションエラー表示
    function showValidationErrors(errors) {
      // 既存のエラー表示をクリア
      document.querySelectorAll('.error-text').forEach(el => el.remove());
      document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
      });

      // 各フィールドにエラーを表示
      Object.entries(errors).forEach(([field, message]) => {
        const input = document.getElementById(field);
        if (input) {
          // 入力欄を赤枠に
          input.classList.remove('border-gray-300');
          input.classList.add('border-red-500');
          
          // エラーメッセージを追加
          const errorDiv = document.createElement('p');
          errorDiv.className = 'error-text text-xs text-red-500 mt-1';
          errorDiv.textContent = message;
          input.parentElement.appendChild(errorDiv);
        }
      });

      // 一般的なエラーメッセージも表示
      showErrorMessage('入力内容に誤りがあります。赤字の項目を確認してください。');
    }

    // エラーメッセージ表示
    function showErrorMessage(message) {
      const element = document.getElementById('errorMessage');
      document.getElementById('errorText').textContent = message;
      element.classList.remove('hidden');
      
      setTimeout(hideErrorMessage, 5000);
    }

    function hideErrorMessage() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    // データベースJSの読み込みを削除（もうLocalStorageを使わない）
  </script>
</body>
</html>
