<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新規プロジェクト登録 - プロジェクト履歴管理システム</title>
  <link rel="icon" type="image/png" href="SP_logo_shape%20only.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <!-- ナビゲーション -->
  <nav class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="Seed_Planning_Logo_Original.jpg" alt="SEED PLANNING" class="h-10">
          <h1 class="text-lg font-bold text-gray-800">プロジェクト履歴管理システム</h1>
        </div>
        <div class="flex space-x-3">
          <a href="index.html" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            <i class="fas fa-home mr-2"></i>ダッシュボード
          </a>
          <a href="register.html" class="px-4 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
            <i class="fas fa-plus mr-2"></i>新規登録
          </a>
          <a href="projects.html" class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            <i class="fas fa-search mr-2"></i>案件検索
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツ -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      
      <!-- ヘッダー -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-plus-circle mr-3 text-green-600"></i>
          新規案件登録
        </h2>
        <p class="text-gray-600 mt-2">リクルート済案件の実績情報を入力してください。1つのプロジェクトで複数のターゲットがあった場合はターゲットごとに入力を繰り返してください。</p>
      </div>

      <!-- 登録フォーム -->
      <form id="projectForm" class="bg-white rounded-lg shadow-md p-6 space-y-6">
        
        <!-- 疾患名 -->
        <div>
          <label for="diseaseName" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-heartbeat mr-2 text-red-600"></i>
            疾患名 <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="diseaseName" 
            name="diseaseName" 
            required
            placeholder="例: アルツハイマー型認知症"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
        </div>

        <!-- 疾患略語 -->
        <div>
          <label for="diseaseAbbr" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-tag mr-2 text-purple-600"></i>
            疾患略語
          </label>
          <input 
            type="text" 
            id="diseaseAbbr" 
            name="diseaseAbbr" 
            placeholder="例: AD, T2DM, COPD"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
        </div>

        <!-- 2列レイアウト -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- 手法 -->
          <div>
            <label for="method" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-clipboard-list mr-2 text-blue-600"></i>
              手法 <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="method" 
              name="method" 
              required
              placeholder="例: IDI, アンケート, 会場調査"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- 調査種別 -->
          <div>
            <label for="surveyType" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-chart-bar mr-2 text-green-600"></i>
              調査種別 <span class="text-red-500">*</span>
            </label>
            <select 
              id="surveyType" 
              name="surveyType" 
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="定性" selected>定性</option>
              <option value="定量">定量</option>
              <option value="その他">その他</option>
            </select>
          </div>
        </div>

        <!-- 対象者種別 -->
        <div>
          <label for="targetType" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-users mr-2 text-green-600"></i>
            対象者種別 <span class="text-red-500">*</span>
          </label>
          <select 
            id="targetType" 
            name="targetType" 
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">選択してください</option>
            <option value="医師">医師</option>
            <option value="患者">患者</option>
            <option value="介護者">介護者</option>
            <option value="医師・患者">医師・患者</option>
            <option value="KOL">KOL</option>
            <option value="看護師">看護師</option>
            <option value="薬剤師">薬剤師</option>
          </select>
        </div>

        <!-- 専門 -->
        <div>
          <label for="specialty" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-md mr-2 text-indigo-600"></i>
            専門（診療科）
          </label>
          <input 
            type="text" 
            id="specialty" 
            name="specialty" 
            placeholder="例: 脳神経内科, 精神科, 糖尿病内科"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
          <p class="text-xs text-gray-500 mt-1">対象者が医師の場合、専門診療科を入力してください</p>
        </div>

        <!-- 実績数 -->
        <div>
          <label for="recruitCount" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-plus mr-2 text-purple-600"></i>
            実績数（リクルート人数） <span class="text-red-500">*</span>
          </label>
          <input 
            type="number" 
            id="recruitCount" 
            name="recruitCount" 
            required
            min="1"
            placeholder="例: 50"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
          
          <!-- 問合せのみチェックボックス -->
          <div class="mt-3 flex items-center">
            <input 
              type="checkbox" 
              id="inquiryOnly" 
              name="inquiryOnly" 
              class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2"
            >
            <label for="inquiryOnly" class="ml-2 text-sm font-medium text-gray-700">
              問合せのみ（推定回収数として記録）
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">※実際のリクルートではなく、問合せ確認数の場合はチェックしてください</p>
        </div>

        <!-- 対象条件 -->
        <div>
          <label for="targetConditions" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-filter mr-2 text-orange-600"></i>
            対象条件（スクリーニング条件） <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="targetConditions" 
            name="targetConditions" 
            rows="3"
            required
            placeholder="例: アルツハイマー型認知症患者を月に20人以上診療"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">リクルート対象の詳細条件を入力してください</p>
        </div>

        <!-- 薬剤 -->
        <div>
          <label for="drug" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-pills mr-2 text-pink-600"></i>
            薬剤（任意）
          </label>
          <input 
            type="text" 
            id="drug" 
            name="drug" 
            placeholder="例: レカネマブ, レケンビ"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
          <p class="text-xs text-gray-500 mt-1">調査対象の薬剤名を入力してください（複数の場合はカンマ区切り）</p>
        </div>

        <!-- 2列レイアウト -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- リクルート実施会社 -->
          <div>
            <label for="recruitCompany" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-building mr-2 text-teal-600"></i>
              リクルート実施（問合せ先）
            </label>
            <input 
              type="text" 
              id="recruitCompany" 
              name="recruitCompany" 
              placeholder="例: キャンドゥ, アスマーク"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- クライアント -->
          <div>
            <label for="client" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-handshake mr-2 text-yellow-600"></i>
              クライアント
            </label>
            <input 
              type="text" 
              id="client" 
              name="client" 
              placeholder="例: The Link Group"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <!-- 新規追加項目 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- モデレーター -->
          <div>
            <label for="moderator" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-user-tie mr-2 text-purple-600"></i>
              モデレーター（任意）
            </label>
            <input 
              type="text" 
              id="moderator" 
              name="moderator" 
              placeholder="例: 山本駿人"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- エンドクライアント -->
          <div>
            <label for="endClient" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-building mr-2 text-blue-600"></i>
              エンドクライアント（任意）
            </label>
            <input 
              type="text" 
              id="endClient" 
              name="endClient" 
              placeholder="例: エーザイ"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- PJ番号 -->
          <div>
            <label for="projectNumber" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-hashtag mr-2 text-indigo-600"></i>
              PJ番号（任意）
            </label>
            <input 
              type="text" 
              id="projectNumber" 
              name="projectNumber" 
              placeholder="例: Y10034163"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <!-- 実施年月 -->
          <div>
            <label for="implementationDate" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-calendar mr-2 text-red-600"></i>
              実施年月（問合せ年月）
            </label>
            <input 
              type="text" 
              id="implementationDate" 
              name="implementationDate" 
              placeholder="例: 2024/11"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
            <p class="text-xs text-gray-500 mt-1">YYYY/MM形式で入力</p>
          </div>

          <!-- 登録担当 -->
          <div>
            <label for="registrant" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-user-check mr-2 text-teal-600"></i>
              登録担当
            </label>
            <input 
              type="text" 
              id="registrant" 
              name="registrant" 
              placeholder="例: 末田"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
        </div>

        <!-- 登録メッセージ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700 text-center">
            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
            登録ありがとうございます。以下のボタンから登録(PR)を作ってください。
          </p>
        </div>

        <!-- 送信ボタン -->
        <div class="flex space-x-4 pt-4">
          <button 
            type="submit" 
            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center space-x-2"
          >
            <i class="fas fa-code-branch"></i>
            <span>この内容でPRを作る</span>
          </button>
          <button 
            type="button" 
            onclick="resetForm()" 
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
          >
            <i class="fas fa-redo mr-2"></i>
            リセット
          </button>
        </div>
      </form>

      <!-- 成功メッセージ -->
      <div id="successMessage" class="hidden mt-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle text-xl"></i>
            <span class="font-semibold">PRを作成しました！</span>
          </div>
          <button onclick="hideSuccessMessage()" class="text-green-700 hover:text-green-900">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="prLinkContainer" class="ml-7">
          <a id="prLink" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 underline flex items-center space-x-2">
            <i class="fab fa-github"></i>
            <span>GitHubでPRを確認する</span>
            <i class="fas fa-external-link-alt text-sm"></i>
          </a>
        </div>
      </div>

      <!-- エラーメッセージ -->
      <div id="errorMessage" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <i class="fas fa-exclamation-circle text-xl"></i>
          <span id="errorText">エラーが発生しました</span>
        </div>
        <button onclick="hideErrorMessage()" class="text-red-700 hover:text-red-900">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 共通設定 -->
  <script src="js/config.js"></script>

  <!-- フォームロジック -->
  <script>
    // Cloudflare Worker API エンドポイント（config.jsから取得）
    const API_ENDPOINT = API.getSubmitUrl();

    // フォーム送信
    document.getElementById('projectForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // 送信ボタンを無効化
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>送信中...</span>';

      // フォームデータを収集
      const formData = {
        diseaseName: document.getElementById('diseaseName').value.trim(),
        diseaseAbbr: document.getElementById('diseaseAbbr').value.trim(),
        method: document.getElementById('method').value.trim(),
        surveyType: document.getElementById('surveyType').value.trim(),
        targetType: document.getElementById('targetType').value,
        specialty: document.getElementById('specialty').value.trim(),
        recruitCount: parseInt(document.getElementById('recruitCount').value) || 0,
        inquiryOnly: document.getElementById('inquiryOnly').checked,
        targetConditions: document.getElementById('targetConditions').value.trim(),
        drug: document.getElementById('drug').value.trim(),
        recruitCompany: document.getElementById('recruitCompany').value.trim(),
        moderator: document.getElementById('moderator').value.trim(),
        client: document.getElementById('client').value.trim(),
        endClient: document.getElementById('endClient').value.trim(),
        projectNumber: document.getElementById('projectNumber').value.trim(),
        implementationDate: document.getElementById('implementationDate').value.trim(),
        registrant: document.getElementById('registrant').value.trim()
      };

      try {
        // API にPOSTリクエスト
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // 成功: PRリンクを表示
          showSuccessMessage(result.prUrl);
          
          // フォームをリセット
          setTimeout(() => {
            resetForm();
          }, 1000);
        } else {
          // エラー: バリデーションエラーを表示
          if (result.details) {
            showValidationErrors(result.details);
          } else {
            showErrorMessage(result.message || 'エラーが発生しました');
          }
        }
      } catch (error) {
        console.error('API Error:', error);
        showErrorMessage('通信エラーが発生しました: ' + error.message);
      } finally {
        // 送信ボタンを再度有効化
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      }
    });

    // フォームをリセット
    function resetForm() {
      document.getElementById('projectForm').reset();
      // バリデーションエラー表示をクリア
      document.querySelectorAll('.error-text').forEach(el => el.remove());
      document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
      });
    }

    // 成功メッセージ表示（PRリンク付き）
    function showSuccessMessage(prUrl) {
      const element = document.getElementById('successMessage');
      const prLink = document.getElementById('prLink');
      
      prLink.href = prUrl;
      element.classList.remove('hidden');
      
      // 自動的に非表示にしない（ユーザーが確認するまで表示）
    }

    function hideSuccessMessage() {
      document.getElementById('successMessage').classList.add('hidden');
    }

    // バリデーションエラー表示
    function showValidationErrors(errors) {
      // 既存のエラー表示をクリア
      document.querySelectorAll('.error-text').forEach(el => el.remove());
      document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
      });

      // 各フィールドにエラーを表示
      Object.entries(errors).forEach(([field, message]) => {
        const input = document.getElementById(field);
        if (input) {
          // 入力欄を赤枠に
          input.classList.remove('border-gray-300');
          input.classList.add('border-red-500');
          
          // エラーメッセージを追加
          const errorDiv = document.createElement('p');
          errorDiv.className = 'error-text text-xs text-red-500 mt-1';
          errorDiv.textContent = message;
          input.parentElement.appendChild(errorDiv);
        }
      });

      // 一般的なエラーメッセージも表示
      showErrorMessage('入力内容に誤りがあります。赤字の項目を確認してください。');
    }

    // エラーメッセージ表示
    function showErrorMessage(message) {
      const element = document.getElementById('errorMessage');
      document.getElementById('errorText').textContent = message;
      element.classList.remove('hidden');
      
      setTimeout(hideErrorMessage, 5000);
    }

    function hideErrorMessage() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    // データベースJSの読み込みを削除（もうLocalStorageを使わない）
  </script>
</body>
</html>
