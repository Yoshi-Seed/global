<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>詳細レポート - プロジェクト履歴管理システム</title>
  <link rel="icon" type="image/png" href="SP_logo_shape_only.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ✅ Project Tracker (GAS) -->
  <!-- js/config.js で GAS_CONFIG / API.getDataUrl() を定義している前提 -->
  <script src="js/config.js" defer></script>
  <script src="js/api.js" defer></script>

  <!-- Dashboard libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --bg:#E8F0F1; --card:#fff; --primary:#1F7A85; --muted:#6b7b83; --ink:#0a2a33; --border:#d6e2e5; --chip:#f1f7f8;
    }
    body { background: var(--bg); color: var(--ink); }
    .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .filter-panel { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .content-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; }
    .filter-block { margin-bottom: 12px; border-top: 1px dashed var(--border); padding-top: 12px; }
    .filter-block:first-child { border-top: none; padding-top: 0; }
    .filter-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .filter-header h3 { font-size: 14px; margin: 0; font-weight: 600; }
    .quick-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .chip { background: var(--chip); border: 1px solid var(--border); padding: 4px 10px; border-radius: 999px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s; }
    .chip:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
    .chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .scroll-list { max-height: 200px; overflow: auto; border: 1px solid var(--border); border-radius: 12px; padding: 8px; margin-top: 8px; }
    .filter-option { display: flex; align-items: center; gap: 8px; padding: 6px 4px; border-radius: 8px; cursor: pointer; }
    .filter-option:hover { background: #f6fbfc; }
    .filter-option label { flex: 1; font-size: 13px; cursor: pointer; }
    .count-badge { font-size: 10px; color: #31585f; background: #e3f0f2; border-radius: 999px; padding: 2px 6px; font-weight: 600; }
    .search-input { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 13px; }
    .kpi-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; }
    .kpi-card { border: 1px solid var(--border); border-radius: 16px; padding: 16px; text-align: center; }
    .kpi-card h4 { margin: 0 0 8px; font-size: 13px; color: var(--muted); font-weight: 600; }
    .kpi-value { font-size: 32px; font-weight: 700; color: var(--primary); }
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    .chart-card { border: 1px solid var(--border); border-radius: 16px; padding: 16px; min-height: 350px; max-height: 400px; display: flex; flex-direction: column; }
    .chart-card h4 { margin: 0 0 12px; font-size: 15px; font-weight: 600; }
    .chart-card canvas { flex: 1; max-height: 320px; }
    .table-wrapper { padding: 12px; }
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    .data-table th, .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    .data-table th { position: sticky; top: 0; background: #fcfeff; font-weight: 600; cursor: pointer; user-select: none; }
    .data-table th:hover { background: #f0f9fa; }
    .toolbar { display: flex; gap: 12px; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); }
    .toolbar-right { display: flex; gap: 8px; align-items: center; }
    .btn { appearance: none; border: 1px solid var(--primary); background: var(--primary); color: #fff; padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .btn:hover { background: #1a6770; border-color: #1a6770; }
    .btn.secondary { background: #fff; color: var(--primary); border-color: var(--primary); }
    .btn.ghost { background: transparent; border-color: var(--border); color: var(--ink); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; background: white; }
    .small-text { font-size: 12px; color: var(--muted); }
    @media (max-width: 1200px) {
      .dashboard-container { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .kpi-cards { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- ナビゲーション -->
  <nav class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-2 sm:px-4 py-2 sm:py-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center space-x-2 sm:space-x-4">
          <img src="Seed_Planning_Logo_Original.jpg" alt="SEED PLANNING" class="h-8 sm:h-10">
          <h1 class="hidden md:block text-lg font-bold text-gray-800">プロジェクト履歴管理システム</h1>
        </div>

        <div class="flex flex-wrap gap-1 sm:gap-2">
          <a href="index.html" class="px-2 sm:px-4 py-2 text-xs sm:text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center">
            <i class="fas fa-home sm:mr-2"></i><span class="hidden sm:inline ml-1">ホーム</span>
          </a>
          <a href="register.html" class="px-2 sm:px-4 py-2 text-xs sm:text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center">
            <i class="fas fa-plus sm:mr-2"></i><span class="hidden sm:inline ml-1">新規登録</span>
          </a>
          <a href="projects.html" class="px-2 sm:px-4 py-2 text-xs sm:text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center">
            <i class="fas fa-search sm:mr-2"></i><span class="hidden sm:inline ml-1">案件検索</span>
          </a>
          <a href="links.html" class="px-2 sm:px-4 py-2 text-xs sm:text-sm text-white rounded-lg transition flex items-center" style="background-color: #1F7A85;">
            <i class="fas fa-link sm:mr-2"></i><span class="hidden sm:inline ml-1">リンク集</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="dashboard-container" style="display: grid; grid-template-columns: 280px 1fr; gap: 16px; margin-top: 20px;">
    <!-- 左：フィルタ -->
    <aside class="filter-panel" aria-label="フィルターパネル">
      <h2 style="font-size: 16px; font-weight: 700; margin: 0 0 8px;">フィルター</h2>
      <p class="small-text" style="margin-bottom: 12px;">選択内容に応じて他の選択肢も自動更新します。</p>

      <div style="margin-bottom: 12px;">
        <input id="search" type="search" class="search-input" placeholder="キーワード検索（クライアント・疾患など）" />
      </div>

      <div class="filter-block">
        <div class="filter-header">
          <h3>クライアント</h3>
          <div class="quick-actions">
            <button class="chip" data-chip="client:selectAll">全選択</button>
            <button class="chip" data-chip="client:clear">クリア</button>
          </div>
        </div>
        <div class="scroll-list" id="clientList"></div>
      </div>

      <div class="filter-block">
        <div class="filter-header">
          <h3>リクルーター</h3>
          <div class="quick-actions">
            <button class="chip" data-chip="recruiter:selectAll">全選択</button>
            <button class="chip" data-chip="recruiter:clear">クリア</button>
          </div>
        </div>
        <div class="scroll-list" id="recruiterList"></div>
      </div>

      <div class="filter-block">
        <div class="filter-header">
          <h3>疾患（Indication）</h3>
          <div class="quick-actions">
            <button class="chip" data-chip="disease:selectAll">全選択</button>
            <button class="chip" data-chip="disease:clear">クリア</button>
          </div>
        </div>
        <div class="scroll-list" id="diseaseList"></div>
      </div>

      <div class="filter-block">
        <div class="filter-header">
          <h3>専門（HCP Specialty）</h3>
          <div class="quick-actions">
            <button class="chip" data-chip="specialty:selectAll">全選択</button>
            <button class="chip" data-chip="specialty:clear">クリア</button>
          </div>
        </div>
        <div class="scroll-list" id="specialtyList"></div>
      </div>

      <p class="small-text" style="margin-top: 12px;">※ Google Sheet（GAS）データから自動読み込み</p>
    </aside>

    <!-- 右：内容 -->
    <section class="content-section">
      <div class="toolbar">
        <div>
          <strong id="recCount" style="font-size: 15px;">0 件</strong>
          <span class="small-text" id="activeFilters"></span>
        </div>
        <div class="toolbar-right">
          <button class="btn secondary" id="downloadBtn" disabled><i class="fas fa-download mr-1"></i>CSV保存</button>
          <button class="btn ghost" id="resetBtn" disabled><i class="fas fa-redo mr-1"></i>リセット</button>
          <label class="small-text" for="viewMode">集計視点：</label>
          <select id="viewMode">
            <option value="overall">全体</option>
            <option value="byRecruiter">リクルーター別</option>
            <option value="byClient">クライアント別</option>
          </select>
        </div>
      </div>

      <div class="kpi-cards">
        <div class="kpi-card"><h4>ユニーク・クライアント</h4><div id="kpiClients" class="kpi-value">-</div></div>
        <div class="kpi-card"><h4>ユニーク・リクルーター</h4><div id="kpiRecruiters" class="kpi-value">-</div></div>
        <div class="kpi-card"><h4>ユニーク・疾患</h4><div id="kpiDiseases" class="kpi-value">-</div></div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <h4>疾患別 件数</h4>
          <div style="position: relative; height: 300px;"><canvas id="chartDisease"></canvas></div>
        </div>
        <div class="chart-card">
          <h4 id="shareTitle">リクルーター別 構成比</h4>
          <div style="position: relative; height: 300px;"><canvas id="chartRecruiter"></canvas></div>
        </div>
      </div>

      <div class="table-wrapper">
        <h4 style="font-size: 15px; font-weight: 600; margin: 0 0 8px;">明細一覧</h4>
        <p class="small-text" style="margin-bottom: 12px;">ヘッダークリックでソート可能</p>
        <div style="overflow: auto; border: 1px solid var(--border); border-radius: 12px; max-height: 600px;">
          <table id="dataTable" class="data-table"></table>
        </div>
        <div class="toolbar" style="border-top: 1px solid var(--border); border-bottom: none;">
          <div class="small-text" id="pageInfo"></div>
          <div class="toolbar-right">
            <button class="btn ghost" id="prevPage"><i class="fas fa-chevron-left"></i> 前へ</button>
            <button class="btn ghost" id="nextPage">次へ <i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Loading -->
  <div id="loadingOverlay" style="display:none; position:fixed; inset:0; background:rgba(232,240,241,0.9); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center;">
      <i class="fas fa-spinner fa-spin" style="font-size:48px; color:#1F7A85; margin-bottom:16px;"></i>
      <p style="font-size:16px; font-weight:600; color:#1F7A85;">データ読み込み中...</p>
    </div>
  </div>

  <script>
    // ------------------ State ------------------
    const state = {
      raw: [],
      headers: [],
      mapping: { client: 'クライアント', recruiter: 'リクルート実施', disease: '疾患名', specialty: '専門', date: '登録日' },
      filters: { client: new Set(), recruiter: new Set(), disease: new Set(), specialty: new Set() },
      search: "",
      page: 1,
      pageSize: 20,
      sort: { key: null, dir: 1 },
      viewMode: 'overall'
    };

    // ------------------ Utils ------------------
    function el(sel) { return document.querySelector(sel); }
    function els(sel) { return Array.from(document.querySelectorAll(sel)); }
    function unique(arr) { const s = new Set(); arr.forEach(v => { if (v !== '' && v != null) s.add(v); }); return Array.from(s); }
    function safeVal(row, key) { const v = row?.[key]; return v == null ? '' : String(v).trim(); }
    function fmtInt(n) { return new Intl.NumberFormat('ja-JP').format(n); }
    function debounce(fn, ms) { let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms||250); }; }
    function toCSV(rows) {
      if (!rows.length) return '';
      const headers = Object.keys(rows[0]);
      const esc = (s) => '"' + String(s).replace(/"/g,'""') + '"';
      return [headers.map(esc).join(',')].concat(
        rows.map(r => headers.map(h => esc(r[h] ?? '')).join(','))
      ).join('\n');
    }

    // ✅ Projects(JSON) → Row(Japanese headers)
    function projectToRow(p) {
      const proj = p || {};
      return {
        'クライアント': proj.client || '',
        'リクルート実施': proj.recruitCompany || '',
        '疾患名': proj.diseaseName || '',
        '専門': proj.specialty || '',
        '疾患略語': proj.diseaseAbbr || '',
        '調査種別': proj.surveyType || '',
        '対象者種別': proj.targetType || '',
        '手法': proj.method || '',
        '対象条件': proj.targetConditions || '',
        '薬剤': proj.drug || '',
        'モデレーター': proj.moderator || '',
        'エンドクライアント': proj.endClient || '',
        'PJ番号': proj.projectNumber || '',
        '実施年月': proj.implementationDate || '',
        '実績数': proj.recruitCount != null ? String(proj.recruitCount) : '',
        '問合せのみ': proj.inquiryOnly || '',
        '登録番号': proj.registrationId || '',
        '登録担当': proj.registrant || '',
        '登録日': proj.registeredDate || '',
        'ID': proj.id != null ? String(proj.id) : ''
      };
    }

    // ------------------ Load Data (GAS via api.js) ------------------
    async function loadData() {
      const overlay = el('#loadingOverlay');
      if (overlay) overlay.style.display = 'flex';

      try {
        if (typeof api === 'undefined' || typeof api.getAllProjects !== 'function') {
          throw new Error('api.js が読み込めていません（js/config.js / js/api.js の配置を確認してください）');
        }

        const projects = await api.getAllProjects(false);
        const rows = (projects || []).map(projectToRow).filter(r => r['疾患名']);

        state.raw = rows;
        state.headers = Object.keys(rows[0] || {});

        if (overlay) overlay.style.display = 'none';
        initializeDashboard();

      } catch (e) {
        console.error(e);
        if (overlay) overlay.style.display = 'none';
        alert('データの読み込みに失敗しました: ' + (e?.message || ''));
      }
    }

    // ------------------ Dashboard core ------------------
    function initializeDashboard() {
      el('#downloadBtn').disabled = false;
      el('#resetBtn').disabled = false;

      Object.keys(state.filters).forEach(dim => {
        const key = state.mapping[dim];
        state.filters[dim] = new Set(unique(state.raw.map(r => safeVal(r, key))));
      });

      state.page = 1;
      state.search = '';
      el('#search').value = '';
      buildAll();
    }

    function getFilteredData() {
      const s = (state.search || '').toLowerCase();
      const dims = Object.keys(state.filters);

      return state.raw.filter(row => {
        for (const dim of dims) {
          const key = state.mapping[dim];
          const v = safeVal(row, key);
          if (!state.filters[dim].has(v)) return false;
        }
        if (!s) return true;
        const hay = dims.map(d => safeVal(row, state.mapping[d])).join(' ').toLowerCase();
        return hay.includes(s);
      });
    }

    function computeFacetOptions(allRows) {
      const dims = Object.keys(state.filters);
      const out = {};
      for (const dim of dims) {
        const key = state.mapping[dim];

        const subset = allRows.filter(row => {
          for (const od of dims) {
            if (od === dim) continue;
            const ok = state.filters[od].has(safeVal(row, state.mapping[od]));
            if (!ok) return false;
          }
          return true;
        });

        const arr = unique(subset.map(r => safeVal(r, key))).sort((a,b)=>a.localeCompare(b,'ja'));
        const counts = Object.fromEntries(arr.map(v => [v, 0]));
        subset.forEach(r => { const v = safeVal(r, key); if (v in counts) counts[v]++; });

        out[dim] = arr.map(v => ({ value: v, count: counts[v] }));
      }
      return out;
    }

    function buildFilterList(dim, items) {
      const list = el('#' + dim + 'List');
      list.innerHTML = '';
      if (!items.length) { list.innerHTML = '<div class="small-text">（項目なし）</div>'; return; }

      for (const it of items) {
        const value = it.value;
        const count = it.count;

        const row = document.createElement('div');
        row.className = 'filter-option';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = dim + '-' + (value || 'empty').replace(/\W+/g, '_');
        cb.checked = state.filters[dim].has(value);
        cb.dataset.dim = dim;
        cb.dataset.val = value;

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.textContent = value || '（空）';
        if (!value) label.style.fontStyle = 'italic';

        const badge = document.createElement('span');
        badge.className = 'count-badge';
        badge.textContent = String(count);

        row.append(cb, label, badge);
        list.append(row);

        cb.addEventListener('change', () => {
          const d = cb.dataset.dim;
          const v = cb.dataset.val;
          if (cb.checked) state.filters[d].add(v);
          else state.filters[d].delete(v);
          state.page = 1;
          buildAll();
        });
      }
    }

    function summarizeFilters() {
      const parts = [];
      for (const dim of Object.keys(state.filters)) {
        const key = state.mapping[dim];
        const selected = state.filters[dim].size;
        const full = unique(state.raw.map(r => safeVal(r, key))).length;
        if (selected !== full) parts.push(`${dim}: ${selected}件選択`);
      }
      el('#activeFilters').textContent = parts.length ? ' | ' + parts.join(' / ') : '';
    }

    function buildKPIs(rows) {
      el('#kpiClients').textContent = fmtInt(unique(rows.map(r => safeVal(r, state.mapping.client))).length);
      el('#kpiRecruiters').textContent = fmtInt(unique(rows.map(r => safeVal(r, state.mapping.recruiter))).length);
      el('#kpiDiseases').textContent = fmtInt(unique(rows.map(r => safeVal(r, state.mapping.disease))).length);
    }

    let chartDisease = null;
    let chartShare = null;

    function buildCharts(rows) {
      const dKey = state.mapping.disease;
      const rKey = state.mapping.recruiter;
      const cKey = state.mapping.client;

      // Disease bar
      const diseaseCounts = {};
      rows.forEach(r => {
        const v = safeVal(r, dKey);
        if (!v) return;
        diseaseCounts[v] = (diseaseCounts[v] || 0) + 1;
      });
      const dLabels = Object.keys(diseaseCounts).sort((a,b)=>diseaseCounts[b]-diseaseCounts[a]).slice(0,12);
      const dData = dLabels.map(l => diseaseCounts[l]);

      if (chartDisease) chartDisease.destroy();
      chartDisease = new Chart(el('#chartDisease'), {
        type: 'bar',
        data: { labels: dLabels, datasets: [{ label: '件数', data: dData, backgroundColor: '#1F7A85' }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });

      // Share doughnut
      const grpKey = (state.viewMode === 'byClient') ? cKey : rKey;
      el('#shareTitle').textContent = (state.viewMode === 'byClient') ? 'クライアント構成比' : 'リクルーター別 構成比';

      const share = {};
      rows.forEach(r => {
        const v = safeVal(r, grpKey);
        if (!v) return;
        share[v] = (share[v] || 0) + 1;
      });
      const labels = Object.keys(share).sort((a,b)=>share[b]-share[a]).slice(0,20);
      const data = labels.map(l => share[l]);

      if (chartShare) chartShare.destroy();
      chartShare = new Chart(el('#chartRecruiter'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, font:{ size:11 } } } } }
      });
    }

    function buildTable(rows) {
      const table = el('#dataTable');
      if (!rows.length) {
        table.innerHTML = '<thead></thead><tbody><tr><td class="small-text">（該当データがありません）</td></tr></tbody>';
        el('#pageInfo').textContent = '';
        return;
      }

      const displayColumns = ['クライアント','リクルート実施','疾患名','専門','疾患略語','調査種別','対象条件','実施年月'];
      const cols = displayColumns.filter(c => c in rows[0]);

      let sorted = rows.slice();
      if (state.sort.key) {
        sorted.sort((a,b)=>String(a[state.sort.key]??'').localeCompare(String(b[state.sort.key]??''),'ja') * state.sort.dir);
      }

      const start = (state.page - 1) * state.pageSize;
      const pageRows = sorted.slice(start, start + state.pageSize);

      const thead = '<thead><tr>' + cols.map(h =>
        `<th data-col="${h}">${h}${state.sort.key===h ? (state.sort.dir>0?' ▲':' ▼') : ''}</th>`
      ).join('') + '</tr></thead>';

      const tbody = '<tbody>' + pageRows.map(r =>
        '<tr>' + cols.map(h => `<td>${r[h] ?? ''}</td>`).join('') + '</tr>'
      ).join('') + '</tbody>';

      table.innerHTML = thead + tbody;

      els('th').forEach(th => th.addEventListener('click', () => {
        const k = th.dataset.col;
        if (state.sort.key === k) state.sort.dir *= -1;
        else state.sort = { key: k, dir: 1 };
        buildAll();
      }));

      const totalPages = Math.max(1, Math.ceil(rows.length / state.pageSize));
      el('#pageInfo').textContent = `${state.page}/${totalPages} ページ（${fmtInt(rows.length)} 件中）`;

      el('#prevPage').onclick = () => { if (state.page > 1) { state.page--; buildTable(rows); } };
      el('#nextPage').onclick = () => { if (state.page < totalPages) { state.page++; buildTable(rows); } };
    }

    function buildFiltersUI(allRows) {
      const facets = computeFacetOptions(allRows);
      for (const dim of Object.keys(facets)) buildFilterList(dim, facets[dim]);
    }

    function buildAll() {
      const rows = getFilteredData();
      el('#recCount').textContent = `${fmtInt(rows.length)} 件`;
      buildKPIs(rows);
      buildFiltersUI(state.raw);
      buildCharts(rows);
      buildTable(rows);
      summarizeFilters();
    }

    function wireChips() {
      els('.chip').forEach(btn => btn.addEventListener('click', () => {
        const [dim, cmd] = btn.dataset.chip.split(':');
        const key = state.mapping[dim];
        const allVals = unique(state.raw.map(r => safeVal(r, key)));
        if (cmd === 'selectAll') state.filters[dim] = new Set(allVals);
        if (cmd === 'clear') state.filters[dim] = new Set();
        state.page = 1;
        buildAll();
      }));
    }

    function wireEvents() {
      el('#search').addEventListener('input', debounce(e => {
        state.search = e.target.value.trim();
        state.page = 1;
        buildAll();
      }, 250));

      el('#resetBtn').addEventListener('click', () => {
        for (const dim of Object.keys(state.filters)) {
          const key = state.mapping[dim];
          state.filters[dim] = new Set(unique(state.raw.map(r => safeVal(r, key))));
        }
        state.search = '';
        el('#search').value = '';
        state.page = 1;
        state.sort = { key: null, dir: 1 };
        buildAll();
      });

      el('#downloadBtn').addEventListener('click', () => {
        const rows = getFilteredData();
        const csv = toCSV(rows);
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `filtered_export_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      });

      el('#viewMode').addEventListener('change', () => {
        state.viewMode = el('#viewMode').value;
        buildAll();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      wireChips();
      wireEvents();
      loadData();
    });
  </script>
</body>
</html>
