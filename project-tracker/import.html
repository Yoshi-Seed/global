<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSVインポート - プロジェクト履歴管理システム</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <!-- ナビゲーション -->
  <nav class="bg-blue-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="Seed_Planning_Medical_Original.jpg" alt="SEED PLANNING MEDICAL Business Unit" class="h-12">
          <h1 class="text-xl font-bold">プロジェクト履歴管理システム</h1>
        </div>
        <div class="flex space-x-4">
          <a href="index.html" class="px-4 py-2 bg-blue-500 rounded hover:bg-blue-600 transition">
            <i class="fas fa-home mr-2"></i>ダッシュボード
          </a>
          <a href="register.html" class="px-4 py-2 bg-green-500 rounded hover:bg-green-600 transition">
            <i class="fas fa-plus mr-2"></i>新規案件登録
          </a>
          <a href="projects.html" class="px-4 py-2 bg-blue-500 rounded hover:bg-blue-600 transition">
            <i class="fas fa-search mr-2"></i>案件検索
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツ -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      
      <!-- ヘッダー -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-file-import mr-3 text-purple-600"></i>
          CSVデータインポート
        </h2>
        <p class="text-gray-600 mt-2">Seed PlanningのCSVデータをインポートして、案件履歴を一括登録できます。</p>
      </div>

      <!-- 自動インポートセクション -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fas fa-magic mr-2 text-green-600"></i>
          ワンクリック自動インポート
        </h3>
        <p class="text-gray-600 mb-4">
          Seed Planningの実績データ（113件）を自動的にインポートします。
        </p>
        <button 
          onclick="autoImportSeedData()" 
          class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 transition font-semibold text-lg flex items-center justify-center space-x-2"
        >
          <i class="fas fa-bolt"></i>
          <span>Seed Planningデータを自動インポート</span>
        </button>
      </div>

      <!-- 手動インポートセクション -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fas fa-upload mr-2 text-blue-600"></i>
          手動CSVアップロード
        </h3>
        
        <!-- CSVフォーマット説明 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <h4 class="font-semibold text-blue-900 mb-2">
            <i class="fas fa-info-circle mr-2"></i>
            CSVフォーマット
          </h4>
          <p class="text-sm text-blue-800 mb-2">以下の列を含むCSVファイルをアップロードしてください：</p>
          <div class="bg-white rounded p-3 text-xs font-mono overflow-x-auto">
            疾患名,疾患略語,手法,調査種別,対象者種別,専門,実績数,対象条件,薬剤,リクルート実施,クライアント
          </div>
        </div>

        <!-- ファイル選択 -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            CSVファイルを選択
          </label>
          <input 
            type="file" 
            id="csvFile" 
            accept=".csv"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
        </div>

        <!-- インポートボタン -->
        <button 
          onclick="importCSVFile()" 
          class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold flex items-center justify-center space-x-2"
        >
          <i class="fas fa-file-upload"></i>
          <span>CSVファイルをインポート</span>
        </button>
      </div>

      <!-- 進行状況 -->
      <div id="progressSection" class="hidden mt-6 bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-bold mb-4">インポート進行状況</h3>
        <div class="mb-2">
          <div class="flex justify-between text-sm mb-1">
            <span id="progressText">処理中...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- 成功メッセージ -->
      <div id="successMessage" class="hidden mt-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle text-xl"></i>
            <div>
              <p class="font-semibold" id="successTitle">インポート成功！</p>
              <p class="text-sm" id="successText"></p>
            </div>
          </div>
          <button onclick="hideSuccessMessage()" class="text-green-700 hover:text-green-900">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="mt-4 flex space-x-3">
          <a href="index.html" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
            <i class="fas fa-home mr-2"></i>ダッシュボードへ
          </a>
          <a href="projects.html" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            <i class="fas fa-list mr-2"></i>データを確認
          </a>
        </div>
      </div>

      <!-- エラーメッセージ -->
      <div id="errorMessage" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="fas fa-exclamation-circle text-xl"></i>
            <div>
              <p class="font-semibold">エラーが発生しました</p>
              <p class="text-sm" id="errorText"></p>
            </div>
          </div>
          <button onclick="hideErrorMessage()" class="text-red-700 hover:text-red-900">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- データベースJS -->
  <script src="js/database.js"></script>

  <!-- インポートロジック -->
  <script>
    // 初期化
    async function initImportPage() {
      await db.init();
      
      // 既存データ確認
      const existingCount = db.getAllProjects().length;
      if (existingCount > 0) {
        if (!confirm(`既に${existingCount}件のデータが存在します。\n新しいデータをインポートすると上書きされます。\n続行しますか？`)) {
          // キャンセルされた場合はダッシュボードへ
          window.location.href = 'index.html';
        }
      }
    }

    // 自動インポート（Seed Planningデータ）
    async function autoImportSeedData() {
      showProgress();
      updateProgress('Seed Planningデータを読み込んでいます...', 20);
      
      try {
        // CSVファイルを読み込み
        const response = await fetch('seed_planning_data.csv');
        const csvText = await response.text();
        
        updateProgress('データを解析しています...', 40);
        
        // インポート実行
        const result = await db.importFromCSV(csvText);
        
        updateProgress('インポート完了', 100);
        
        if (result.success) {
          hideProgress();
          showSuccessMessage(`${result.count}件のデータをインポートしました！`, 
            'ダッシュボードでデータを確認できます。');
        } else {
          hideProgress();
          showErrorMessage('インポートに失敗しました: ' + result.error);
        }
      } catch (error) {
        hideProgress();
        showErrorMessage('ファイルの読み込みに失敗しました: ' + error.message);
      }
    }

    // 手動CSVインポート
    async function importCSVFile() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showErrorMessage('CSVファイルを選択してください');
        return;
      }

      showProgress();
      updateProgress('ファイルを読み込んでいます...', 20);

      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const csvText = e.target.result;
        
        updateProgress('データを解析しています...', 40);
        
        try {
          const result = await db.importFromCSV(csvText);
          
          updateProgress('インポート完了', 100);
          
          if (result.success) {
            hideProgress();
            showSuccessMessage(`${result.count}件のデータをインポートしました！`,
              'ダッシュボードでデータを確認できます。');
          } else {
            hideProgress();
            showErrorMessage('インポートに失敗しました: ' + result.error);
          }
        } catch (error) {
          hideProgress();
          showErrorMessage('データの解析に失敗しました: ' + error.message);
        }
      };

      reader.onerror = function() {
        hideProgress();
        showErrorMessage('ファイルの読み込みに失敗しました');
      };

      reader.readAsText(file, 'UTF-8');
    }

    // 進行状況表示
    function showProgress() {
      document.getElementById('progressSection').classList.remove('hidden');
    }

    function hideProgress() {
      document.getElementById('progressSection').classList.add('hidden');
    }

    function updateProgress(text, percent) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressBar').style.width = percent + '%';
    }

    // 成功メッセージ表示
    function showSuccessMessage(title, text) {
      const element = document.getElementById('successMessage');
      document.getElementById('successTitle').textContent = title;
      document.getElementById('successText').textContent = text;
      element.classList.remove('hidden');
    }

    function hideSuccessMessage() {
      document.getElementById('successMessage').classList.add('hidden');
    }

    // エラーメッセージ表示
    function showErrorMessage(message) {
      const element = document.getElementById('errorMessage');
      document.getElementById('errorText').textContent = message;
      element.classList.remove('hidden');
      
      setTimeout(hideErrorMessage, 8000);
    }

    function hideErrorMessage() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    // ページ読み込み時に実行
    window.addEventListener('DOMContentLoaded', initImportPage);
  </script>
</body>
</html>
