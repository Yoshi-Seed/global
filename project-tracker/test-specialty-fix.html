<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>診療科オートコンプリート動作テスト</title>
  <link rel="icon" type="image/png" href="SP_logo_shape_only.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/style-2026.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="js/utils.js"></script>
  <script src="js/data/specialties-master.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-2xl mx-auto p-8">
    <h1 class="text-2xl font-bold mb-6">診療科オートコンプリート テスト</h1>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="relative" id="specialty-combobox">
        <label for="specialtyInput" class="block text-sm font-medium text-gray-700 mb-2">
          専門（診療科）
        </label>
        <input
          id="specialtyInput"
          type="text"
          autocomplete="off"
          role="combobox"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-controls="specialtyList"
          placeholder="先頭2〜3文字で候補表示（例：内科、循環器、皮膚）"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
        />
        
        <ul id="specialtyList" role="listbox" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto">
        </ul>
        
        <div id="specialtyError" class="hidden mt-2 text-sm text-red-600"></div>
      </div>
      
      <div class="mt-4 p-4 bg-gray-100 rounded">
        <p class="text-sm font-medium mb-2">選択結果:</p>
        <div id="result">まだ選択されていません</div>
      </div>
    </div>
    
    <div class="mt-6 bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold mb-4">デバッグ情報</h2>
      <pre id="debug" class="text-xs bg-gray-900 text-gray-300 p-4 rounded overflow-x-auto"></pre>
    </div>
  </div>

  <script>
    // デバッグ情報表示
    const debug = document.getElementById('debug');
    const result = document.getElementById('result');
    
    document.addEventListener('DOMContentLoaded', function() {
      let debugInfo = '';
      
      // SpecialtyMasterの確認
      debugInfo += 'SpecialtyMaster loaded: ' + (typeof SpecialtyMaster !== 'undefined') + '\n';
      
      if (typeof SpecialtyMaster !== 'undefined') {
        const specialties = SpecialtyMaster.getAllSpecialties();
        debugInfo += 'Total specialties: ' + specialties.length + '\n';
        debugInfo += 'Sample specialties:\n';
        specialties.slice(0, 5).forEach(s => {
          debugInfo += `  - ${s.code}: ${s.ja} (${s.en})\n`;
        });
      }
      
      debug.textContent = debugInfo;
      
      // 簡単なオートコンプリート実装
      const input = document.getElementById('specialtyInput');
      const list = document.getElementById('specialtyList');
      const error = document.getElementById('specialtyError');
      
      if (typeof SpecialtyMaster === 'undefined') {
        error.textContent = 'SpecialtyMasterが読み込まれていません';
        error.classList.remove('hidden');
        return;
      }
      
      const specialties = SpecialtyMaster.getAllSpecialties();
      
      // 正規化関数
      const normalize = (s) => (s || '').toString().trim().toLowerCase().replace(/\s+/g, '').normalize('NFKC');
      
      // 入力イベント
      input.addEventListener('input', function() {
        const query = normalize(this.value);
        
        if (!query) {
          list.classList.add('hidden');
          return;
        }
        
        // 候補を検索
        const matches = specialties.filter(s => {
          const ja = normalize(s.ja);
          const en = normalize(s.en || '');
          const code = normalize(s.code);
          
          return ja.includes(query) || en.includes(query) || code.includes(query);
        }).slice(0, 10);
        
        // リストを更新
        list.innerHTML = '';
        
        if (matches.length === 0) {
          list.classList.add('hidden');
          return;
        }
        
        matches.forEach((s, idx) => {
          const li = document.createElement('li');
          li.className = 'px-3 py-2 cursor-pointer hover:bg-indigo-50 text-sm';
          li.innerHTML = `
            <span class="font-medium">${s.ja}</span>
            <span class="text-gray-500 ml-2">(${s.en})</span>
            <span class="text-gray-400 ml-2 text-xs">#${s.code}</span>
          `;
          
          li.addEventListener('click', function() {
            input.value = s.ja;
            result.innerHTML = `
              <div class="space-y-1">
                <div><span class="font-medium">日本語:</span> ${s.ja}</div>
                <div><span class="font-medium">英語:</span> ${s.en}</div>
                <div><span class="font-medium">コード:</span> ${s.code}</div>
              </div>
            `;
            list.classList.add('hidden');
          });
          
          list.appendChild(li);
        });
        
        list.classList.remove('hidden');
      });
      
      // クリックアウトで閉じる
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#specialty-combobox')) {
          list.classList.add('hidden');
        }
      });
    });
  </script>
</body>
</html>