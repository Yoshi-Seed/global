# アンケート作成システム MVP 仕様（SPEC）

## 1. 目的とスコープ

本MVPは、**最小の運用負荷でアンケートを作成・配布・回収・集計確認できること**を目的とする。
対象は以下の2ロール:

- **作成者（Admin/Editor）**: アンケート作成、公開設定、回答の閲覧
- **回答者（Respondent）**: 配布URLにアクセスして回答送信

MVP段階では、複雑な分岐ロジックや高度分析は対象外とし、確実な配布・回収・監査可能性を優先する。

---

## 2. 想定ユースケース

1. 作成者が新規アンケートを作成する。
2. 設問（単一選択/複数選択/自由記述）を設定し公開する。
3. 回答者が公開URLから回答する。
4. システムは回答を保存し、作成者は管理画面で集計結果を確認する。
5. 変更履歴やアクセス履歴を監査ログとして確認できる。

---

## 3. 機能要件（作成者機能）

### 3.1 アカウント・認証

- メール＋パスワードでログインできる。
- 作成者ロールのみ作成・編集・閲覧（管理機能）にアクセス可能。
- パスワード再設定（メールリンク）を提供する。

### 3.2 アンケート管理

- アンケートを新規作成できる（タイトル、説明、公開状態）。
- 公開状態は以下:
  - `draft`（下書き）
  - `published`（公開中）
  - `closed`（受付終了）
- 公開URLを生成・再表示できる。
- 受付期間（開始日時/終了日時）を設定可能（任意）。

### 3.3 設問管理

- 設問の追加/編集/削除/表示順変更ができる。
- MVP対応設問タイプ:
  - 単一選択（radio）
  - 複数選択（checkbox）
  - 自由記述（text/textarea）
- 設問ごとに必須/任意を設定できる。
- 単一選択・複数選択には選択肢を設定できる。

### 3.4 回答結果閲覧

- 回答件数を一覧で確認できる。
- 設問ごとの単純集計を確認できる。
  - 単一/複数選択: 選択肢ごとの件数
  - 自由記述: 回答一覧表示（検索はMVP外）
- 回答データのCSVエクスポート（UTF-8）を提供する。

### 3.5 監査・運用

- 主要操作（作成、更新、公開、クローズ、削除）を監査ログに記録。
- 監査ログは作成者（権限者）のみ閲覧可能。

---

## 4. 機能要件（回答者動線）

### 4.1 回答開始

- 回答者は公開URLへアクセスする。
- アンケート状態チェック:
  - `draft`: 非公開メッセージ表示
  - `closed`: 受付終了メッセージ表示
  - 受付期間外: 期間外メッセージ表示
  - `published`かつ期間内: 回答フォーム表示

### 4.2 回答入力

- 設問順に入力できる。
- クライアント側で必須チェックを実施。
- サーバ側でも同等の必須バリデーションを実施（二重検証）。

### 4.3 回答送信

- 送信時に以下を実施:
  - フォーム全体バリデーション
  - CSRF対策トークン検証（Cookie運用時）
  - レート制限チェック
- 成功時は完了画面（サンクスページ）へ遷移。
- 二重送信防止のため、送信後は再送ボタン抑止またはidempotencyキー利用。

### 4.4 エラー時挙動

- バリデーションエラー: 該当設問にエラーメッセージ表示。
- サーバエラー: 汎用エラーメッセージ＋再試行導線。
- タイムアウト: 入力内容の一時保持（ブラウザ内）を推奨。

---

## 5. データモデル前提

> 実装DBはPostgreSQLを想定。RLS適用を前提とする。

### 5.1 エンティティ

- `users`
  - 作成者アカウント情報
- `surveys`
  - アンケート本体（タイトル、状態、公開期間、作成者）
- `questions`
  - 設問定義（タイプ、必須、表示順）
- `choices`
  - 選択式設問の選択肢
- `responses`
  - 回答単位（1送信=1レコード）
- `answers`
  - 設問ごとの回答値
- `audit_logs`
  - 監査ログ（誰が、いつ、何を、対象ID、差分）

### 5.2 主要リレーション

- `surveys.created_by -> users.id`
- `questions.survey_id -> surveys.id`
- `choices.question_id -> questions.id`
- `responses.survey_id -> surveys.id`
- `answers.response_id -> responses.id`
- `answers.question_id -> questions.id`

### 5.3 回答データ保持方針

- 単一選択: `answers.choice_id` に1値保持
- 複数選択: `answers`を選択数分作成（1選択=1行）
- 自由記述: `answers.text_value` に保持
- 監査上必要なため、回答送信時刻・送信元IP（必要最小限/マスキング方針）・UAを `responses` に保持

### 5.4 削除ポリシー

- MVPでは論理削除を原則（`deleted_at`）とする。
- 回答データは原則物理削除しない（法務要件確定後に再定義）。

---

## 6. 非機能要件

### 6.1 セキュリティ

- 認証: セッションまたはJWT。管理系APIは認証必須。
- 認可: ロールベース（最低限 `creator` と `respondent/public`）。
- 入力値検証:
  - クライアント/サーバ両方で実施
  - SQLインジェクション対策（プレースホルダ）
  - XSS対策（出力時エスケープ）
- 通信: 全通信HTTPS必須。
- レート制限:
  - 回答送信APIにIPベースの閾値を設定
  - 管理ログインAPIにブルートフォース対策
- シークレット管理: 環境変数＋秘密情報マネージャ利用。

### 6.2 RLS（Row Level Security）

- `surveys/questions/choices/responses/answers/audit_logs` はRLS有効化。
- 基本ポリシー:
  - 作成者は**自分が作成したsurvey配下データのみ**参照/更新可能。
  - 公開回答APIは `published` なsurveyへの `responses/answers` 挿入のみ許可。
  - 公開ロールから `responses/answers` の参照は禁止。
- サービスロール（バッチ/運用）は最小権限で限定利用。

### 6.3 監査ログ

- 対象イベント:
  - ログイン成功/失敗
  - アンケート作成/更新/公開/クローズ/削除
  - 設問・選択肢の変更
  - エクスポート実行
- ログ項目:
  - `event_type`, `actor_user_id`, `target_type`, `target_id`, `timestamp`, `metadata(diff)`
- 改ざん耐性:
  - 追記専用テーブル
  - 更新/削除不可ポリシー（DB権限制御）

### 6.4 可用性・性能（MVP目標）

- 稼働率目標: 月間99.5%以上。
- 想定負荷: 同時回答 100 セッション程度。
- 回答送信APIのp95: 1.0秒以内。
- 日次バックアップ（RPO 24h）、障害時RTO 4hを暫定目標。

### 6.5 プライバシー・コンプライアンス

- 個人情報は必要最小限のみ取得。
- 利用目的・保存期間を明示。
- 退会/削除要請への運用手順を定義（MVPでは手動運用可）。

---

## 7. 画面・API（MVP最小構成）

### 7.1 画面

- 作成者:
  - ログイン画面
  - アンケート一覧画面
  - アンケート編集画面
  - 回答集計画面
  - 監査ログ画面
- 回答者:
  - 回答フォーム画面
  - 回答完了画面
  - 受付外/終了メッセージ画面

### 7.2 API（例）

- `POST /api/auth/login`
- `POST /api/surveys`
- `GET /api/surveys`
- `PATCH /api/surveys/:id`
- `POST /api/surveys/:id/questions`
- `POST /api/public/surveys/:publicToken/responses`
- `GET /api/surveys/:id/results`
- `GET /api/surveys/:id/export.csv`
- `GET /api/audit-logs`

---

## 8. MVPで実施しないこと（非スコープ）

- 高度な分岐ロジック（回答による次設問制御）
- 多言語対応
- リアルタイムダッシュボード
- 外部BI連携
- 高度な不正回答検知（指紋、bot判定など）

---

## 9. 受け入れ基準（抜粋）

- 作成者がアンケートを作成→公開→URL共有できる。
- 回答者が公開中アンケートへ回答し、送信完了できる。
- 作成者が回答集計とCSVを取得できる。
- RLSにより、他作成者データへアクセスできない。
- 主要操作が監査ログに記録される。

---

## 10. 質問リスト（曖昧点）

1. 回答者の本人認証は不要（匿名）で確定か、組織アカウント限定か。
2. 1人あたり回答回数は1回制限か、複数回許可か。
3. 公開URLの秘匿レベル（推測困難トークン長、失効運用）の要件。
4. 保存するIPアドレスの粒度（フル保持/マスキング/保持しない）。
5. 自由記述の最大文字数・禁止語フィルタ要件。
6. CSVエクスポートの文字コード・列順の厳密仕様。
7. 監査ログの保存期間とアーカイブ方針。
8. 障害時の通知チャネル（メール/Slack等）と運用責任者。
9. 法務/コンプライアンス上の同意文面（利用目的・保存期間）の確定有無。
10. 将来的な要件（多言語、分岐、外部連携）の優先順位。
