<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【グラフ改善版】海外企業 売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }
        /* モーダル表示時の背景固定 */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">海外企業 売上分析ダッシュボード</h1>
            <p class="text-md text-gray-600 mt-2">38期〜43期までの売上データの推移（※43期は集計途中のデータです）</p>
        </header>

        <!-- 全体の売上推移 -->
        <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">全体の売上推移</h2>
            <div class="chart-container">
                <canvas id="total-sales-chart"></canvas>
            </div>
        </div>

        <!-- ✨ AI Analysis Section -->
        <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-indigo-500" viewBox="0 0 16 16"><path d="M5.05.316a.5.5 0 0 1 .318.858L4.333 2H5.5a.5.5 0 0 1 .4.8L4.25 4.5h1.25a.5.5 0 0 1 .4.8L4.25 7.5h1.25a.5.5 0 0 1 .4.8L4.333 10H5.5a.5.5 0 0 1 .4.8l-1.033 1.834a.5.5 0 0 1-.858-.318L3.667 12H2.5a.5.5 0 0 1-.4-.8l1.033-1.833H1.5a.5.5 0 0 1-.4-.8l1.033-1.834H1.5a.5.5 0 0 1-.4-.8l1.033-1.833H2.5a.5.5 0 0 1 .4-.8L1.833.316a.5.5 0 0 1 .858.318L3.667 2H5.5a.5.5 0 0 1-.45.684L5.05.316zm8 .032c.33.18.33.64 0 .82l-1.033 1.833H13.5a.5.5 0 0 1 .4.8L12.25 6.5h1.25a.5.5 0 0 1 .4.8L12.25 9.5h1.25a.5.5 0 0 1 .4.8L12.25 12.5h1.25a.5.5 0 0 1 .4.8l-1.033 1.834a.5.5 0 0 1-.858-.318L11.667 14H10.5a.5.5 0 0 1-.4-.8l1.033-1.833H9.5a.5.5 0 0 1-.4-.8l1.033-1.834H9.5a.5.5 0 0 1-.4-.8l1.033-1.833H10.5a.5.5 0 0 1 .4-.8L9.833.35a.5.5 0 0 1 .858.318L11.667 2H13.5a.5.5 0 0 1-.45.684l.5-.268z"/></svg>
                AIデータ分析
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Gemini APIを利用して、売上データの傾向を分析します。分析したい項目を選択してください。
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="analyze-total-button" class="flex items-center justify-center gap-2 w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    ✨ 全体の傾向を分析
                </button>
                <button id="analyze-companies-button" class="flex items-center justify-center gap-2 w-full sm:w-auto bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                    ✨ 選択した企業を比較
                </button>
            </div>
        </div>

        <!-- 企業別の売上推移 -->
        <div class="bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">企業別の売上推移</h2>
            <div class="mb-6">
                <p class="text-sm text-gray-600 mb-2">表示する企業を選択してください（上位10社をデフォルトで表示）:</p>
                <div id="company-filter" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
            </div>
            <div class="chart-container">
                <canvas id="company-sales-chart"></canvas>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>データ提供: 38期以降43期まで トップ10海外会社.xlsx</p>
        </footer>
    </div>
    
    <!-- AI分析結果表示モーダル -->
    <div id="ai-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-2xl bg-white">
            <div class="mt-3">
                <h3 class="text-xl leading-6 font-bold text-gray-900 text-center" id="modal-title">AIによる分析結果</h3>
                <div class="mt-4 px-2 py-3 max-h-[60vh] overflow-y-auto">
                    <div id="modal-content" class="text-sm text-gray-700 text-left whitespace-pre-wrap p-4 bg-gray-50 rounded-lg border"></div>
                    <div id="modal-loading" class="text-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
                        <p class="mt-4 text-gray-600">AIが分析中です。少々お待ちください...</p>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- データ提供 ---
        const csvData = `期,順位,組織,売上（税抜）
38期,1,Holden,21266800
38期,2,GLocalMind Inc.,13915587
38期,3,Asia Medical & Professional Research,8872250
38期,4,Purdie Pascoe,6295000
38期,5,PSL Group Services S?RL,4224226
38期,6,QualWorld,3310475
38期,7,AM-Pharma B.V.,2600000
38期,8,Just-Worldwide,1347800
38期,9,"Borderless Access Private Limited,",1327422
38期,10,Cathaya Technologies LLC,1322178
39期,1,The Link Group,57843800
39期,2,Escalent,22079200
39期,3,Holden,16903954
39期,4,GLocalMind Inc.,9758792
39期,5,The Planning Shop,8595750
39期,6,Purdie Pascoe,8374500
39期,7,sermo,7711546
39期,8,Survey Healthcare Globus,7428737
39期,9,Cello Health Insight,6788121
39期,10,Insync,5216500
40期,1,Holden,81270985
40期,2,The Link Group,62716350
40期,3,The Planning Shop,19977700
40期,4,sermo,17621505
40期,5,Escalent,11797750
40期,6,GLocalMind Inc.,10141215
40期,7,fieldcats,9122500
40期,8,Medicem Group a.s.,6700000
40期,9,Asia Medical & Professional Research,6500000
40期,10,Medefield,5962750
41期,1,The Link Group,84391133
41期,2,Holden,74977636
41期,3,The Planning Shop,39417000
41期,4,fieldcats,17192100
41期,5,sermo,16845103
41期,6,GLocalMind Inc.,16067000
41期,7,Escalent,14860000
41期,8,Cello Health Insight,10015000
41期,9,Purdie Pascoe,7500000
41期,10,Just-Worldwide,6400000
42期,1,The Link Group,111791240
42期,2,Holden,104025183
42期,3,The Planning Shop,47806080
42期,4,Market Xcel USA,21973000
42期,5,Escalent,17160000
42期,6,sermo,15372500
42期,7,GLocalMind Inc.,15222000
42期,8,fieldcats,14900000
42期,9,Cello Health Insight,11700000
42期,10,Purdie Pascoe,7950000
43期,1,Holden,39812687
43期,2,The Link Group,26521650
43期,3,The Planning Shop,14120000
43期,4,"FieldCats, Inc.",8251000
43期,5,GLocalMind Inc.,5710000
43期,6,sermo,4725000
43期,7,Purdie Pascoe,2000000
43期,8,Escalent,1500000
43期,9,M3 Global Research,1450000
43期,10,Medefield,1000000`;

        // --- Gemini API設定 ---
        const apiKey = "AIzaSyB-V6HbuAuOGqr62yF6IC92xbWlggwlQrE"; 

        let totalSalesChartInstance;
        let companySalesChartInstance;

        document.addEventListener('DOMContentLoaded', function() {
            // 1. データのパースと前処理
            const parsedData = d3.csvParse(csvData, d => {
                return {
                    term: parseInt(d.期.replace('期', '')),
                    rank: +d.順位,
                    company: d.組織.replace(/,$/, '').replace('S?RL', 'SARL').replace('fieldcats', 'FieldCats, Inc.').trim(),
                    sales: +d['売上（税抜）']
                };
            });
            
            // 2. グラフの描画
            drawTotalSalesChart(parsedData);
            setupCompanyFilter(parsedData);
            updateCompanyChart(parsedData);
            
            // 3. AI分析機能のイベントリスナー設定
            setupAIAnalysis(parsedData);
        });

        function formatSales(value) {
            if (value >= 100000000) return (value / 100000000).toFixed(2) + '億円';
            if (value >= 10000) return (value / 10000).toFixed(0) + '万円';
            return value.toLocaleString() + '円';
        }

        const chartOptions = {
            maintainAspectRatio: false,
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatSales(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString() + '円';
                            }
                            return label;
                        }
                    }
                }
            }
        };

        // --- 全体の売上推移グラフ (Chart.js) ---
        function drawTotalSalesChart(data) {
            const ctx = document.getElementById('total-sales-chart').getContext('2d');
            const totalSalesByTerm = d3.rollup(data, v => d3.sum(v, d => d.sales), d => d.term);
            const totalSalesData = Array.from(totalSalesByTerm, ([key, value]) => ({term: key, totalSales: value})).sort((a, b) => a.term - b.term);
            
            const labels = totalSalesData.map(d => `${d.term}期`);
            const sales = totalSalesData.map(d => d.totalSales);

            if (totalSalesChartInstance) {
                totalSalesChartInstance.destroy();
            }

            totalSalesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '合計売上',
                        data: sales,
                        backgroundColor: 'rgba(74, 144, 226, 0.6)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
        }

        // --- 企業別の売上推移グラフ (Chart.js) ---
        function setupCompanyFilter(data) {
            const filterContainer = document.getElementById("company-filter");
            const salesByCompany = d3.rollup(data, v => d3.sum(v, d => d.sales), d => d.company);
            const topCompanies = Array.from(salesByCompany, ([key, value]) => ({company: key, totalSales: value}))
                .sort((a, b) => b.totalSales - a.totalSales)
                .map(d => d.company);
            const allCompanies = [...new Set(data.map(d => d.company))].sort();
            
            const top10 = topCompanies.slice(0, 10);
            
            allCompanies.forEach(company => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const companyId = `cb-${company.replace(/\W/g, '-')}`;
                const isChecked = top10.includes(company) ? 'checked' : '';

                div.innerHTML = `
                    <input type="checkbox" id="${companyId}" value="${company}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked}>
                    <label for="${companyId}" class="ml-2 block text-sm text-gray-900 truncate" title="${company}">${company}</label>
                `;
                filterContainer.appendChild(div);
            });
                
            filterContainer.addEventListener("change", () => updateCompanyChart(data));
        }

        function updateCompanyChart(data) {
            const ctx = document.getElementById('company-sales-chart').getContext('2d');
            const selectedCompanyNodes = document.querySelectorAll("#company-filter input:checked");
            const selectedCompanies = Array.from(selectedCompanyNodes).map(node => node.value);
            
            document.getElementById('analyze-companies-button').disabled = selectedCompanies.length === 0;

            const filteredData = data.filter(d => selectedCompanies.includes(d.company));
            const terms = [...new Set(data.map(d => d.term))].sort((a,b) => a - b);
            const labels = terms.map(t => `${t}期`);

            const datasets = selectedCompanies.map((company, index) => {
                const companyData = filteredData.filter(d => d.company === company);
                const salesData = terms.map(term => {
                    const termData = companyData.find(d => d.term === term);
                    return termData ? termData.sales : null; // データがない期はnullにする
                });
                const color = Chart.defaults.color.split(',')[index % 10]; // 色を循環させる

                return {
                    label: company,
                    data: salesData,
                    fill: false,
                    tension: 0.1,
                    spanGaps: true // nullの箇所を線で結ばない
                };
            });

            if (companySalesChartInstance) {
                companySalesChartInstance.data.labels = labels;
                companySalesChartInstance.data.datasets = datasets;
                companySalesChartInstance.update();
            } else {
                companySalesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: chartOptions
                });
            }
        }

        // --- AI分析機能 ---
        function setupAIAnalysis(data) {
            const modal = document.getElementById('ai-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const analyzeTotalButton = document.getElementById('analyze-total-button');
            const analyzeCompaniesButton = document.getElementById('analyze-companies-button');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalLoading = document.getElementById('modal-loading');

            const openModal = () => {
                modal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            };
            const closeModal = () => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            };

            closeModalButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            analyzeTotalButton.addEventListener('click', async () => {
                openModal();
                modalTitle.textContent = 'AIによる全体の傾向分析';
                modalContent.classList.add('hidden');
                modalLoading.classList.remove('hidden');

                if (!apiKey) {
                    modalContent.textContent = 'エラー: Gemini APIキーが設定されていません。スクリプト内の`apiKey`に変数を設定してください。';
                    modalLoading.classList.add('hidden');
                    modalContent.classList.remove('hidden');
                    return;
                }

                const totalSalesByTerm = d3.rollup(data, v => d3.sum(v, d => d.sales), d => d.term);
                const totalSalesData = Array.from(totalSalesByTerm, ([key, value]) => ({term: key, totalSales: value})).sort((a, b) => a.term - b.term);
                const promptData = totalSalesData.map(d => `${d.term}期: ${d.totalSales.toLocaleString()}円`).join('\n');
                
                const prompt = `以下のデータは、ある事業の38期から43期までのトップ10海外企業の合計売上推移です。このデータの傾向を専門家として分析し、要点を箇条書きでまとめてください。特に、成長のトレンド、ピーク時、今後の見通しについて具体的に言及してください。重要：43期のデータは第1四半期のみの途中経過の数値であるため、通期の売上予測をする際はその点を必ず加味してください。\n\n[売上データ]\n${promptData}`;

                try {
                    const result = await callGemini(prompt);
                    modalContent.textContent = result;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    modalContent.textContent = `分析中にエラーが発生しました。\n${error.message}`;
                } finally {
                    modalLoading.classList.add('hidden');
                    modalContent.classList.remove('hidden');
                }
            });

            analyzeCompaniesButton.addEventListener('click', async () => {
                const selectedCompanyNodes = document.querySelectorAll("#company-filter input:checked");
                const selectedCompanies = Array.from(selectedCompanyNodes).map(node => node.value);
                if (selectedCompanies.length === 0) return;

                openModal();
                modalTitle.textContent = 'AIによる企業比較分析';
                modalContent.classList.add('hidden');
                modalLoading.classList.remove('hidden');

                if (!apiKey) {
                    modalContent.textContent = 'エラー: Gemini APIキーが設定されていません。スクリプト内の`apiKey`に変数を設定してください。';
                    modalLoading.classList.add('hidden');
                    modalContent.classList.remove('hidden');
                    return;
                }

                const filteredData = data.filter(d => selectedCompanies.includes(d.company));
                const dataByCompany = d3.group(filteredData, d => d.company);
                let promptData = '';
                dataByCompany.forEach((sales, company) => {
                    promptData += `企業: ${company}\n`;
                    const salesString = sales.sort((a,b) => a.term - b.term).map(d => `  ${d.term}期: ${d.sales.toLocaleString()}円`).join('\n');
                    promptData += salesString + '\n\n';
                });

                const prompt = `あなたは優秀な経営コンサルタントです。以下の2つの情報源を基に、企業比較分析レポートを作成してください。

情報源1：各社の売上推移データ
情報源2：あなたが持つ、これらの企業に関するWeb上の公開情報（事業内容、市場での評判、主要なサービスなど）

分析レポートには、以下の要素を含めてください：
・各社の強みと弱み
・成長性と安定性の評価
・売上データと公開情報から見える市場でのポジショニング
・特に注目すべき企業とその理由
・今後の動向予測

重要：43期のデータは第1四半期のみの途中経過の数値です。この点を必ず考慮して分析してください。

[売上データ]
${promptData}`;

                try {
                    const result = await callGemini(prompt);
                    modalContent.textContent = result;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    modalContent.textContent = `分析中にエラーが発生しました。\n${error.message}`;
                } finally {
                    modalLoading.classList.add('hidden');
                    modalContent.classList.remove('hidden');
                }
            });
        }

        async function callGemini(prompt, retries = 3, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { temperature: 0.5, topK: 40, topP: 0.95, } };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const finishReason = result.candidates?.[0]?.finishReason;
                        if (finishReason === 'SAFETY') {
                           return "AIの安全基準により、応答を生成できませんでした。プロンプトを変更して再度お試しください。";
                        }
                        throw new Error("APIから予期しない形式の応答がありました。");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
    </script>
</body>
</html>
