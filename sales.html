<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>42期／43期（途中） 営業実績インフォグラフィック</title>
  <style>
    :root{--gap:12px;--bg:#f7f7fb;--ink:#111827;--muted:#6b7280;--brand:#4c6fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Sans","Noto Sans JP","Yu Gothic UI",sans-serif}
    header{padding:18px 20px 8px}
    h1{font-size:20px;margin:0 0 4px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{padding:0 16px 24px;max-width:1200px;margin:0 auto}
    .panel{background:#fff;border:1px solid #e7e7ef;border-radius:16px;padding:14px;margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media (min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .controls{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;margin:6px 0 10px}
    .btn{appearance:none;border:1px solid #d7d7e5;border-radius:999px;background:#fff;padding:8px 12px;font-size:13px;color:#333;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .kpi{display:flex;flex-wrap:wrap;gap:10px}
    .kpi .card{flex:1 1 180px;background:#f9fafb;border:1px solid #eef0f7;border-radius:12px;padding:10px}
    .kpi .title{font-size:12px;color:#6b7280}
    .kpi .value{font-size:18px;font-weight:600}
    .alert{background:#fff8f0;border:1px solid #ffd9b5;color:#8a4b16;border-radius:12px;padding:10px;font-size:13px}
    #chart42,#chart43,#chartOrg42,#chartOrg43,#chartTLGHolden42,#chartTLGHolden43{width:100%;height:420px}
    .foot{font-size:12px;color:var(--muted)}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:12px;padding:10px;margin-top:10px;font-size:13px;display:none}
  </style>
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>42期・43期（途中）営業実績インフォグラフィック</h1>
  <div class="sub">対象：<b>海外クライアントのみ</b>（画像掲載の組織）。表記ゆれは正規化（例：INTERFACEHOLDEN-ASIA → Holden）。<b>担1列は無視</b>。43期は<b>3〜7月</b>のみ集計。</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="controls">
      <input type="file" id="file" accept=".xlsx,.xls" />
      <button class="btn primary" id="btnLoad">読み込む</button>
      <button class="btn" id="btnDownload">画像を保存（PNG）</button>
    </div>
    <div id="err" class="error"></div>
    <div class="kpi" id="kpis">
      <div class="card"><div class="title">42期 合計（海外）</div><div class="value" id="k42">-</div></div>
      <div class="card"><div class="title">43期（3–7月）合計（海外）</div><div class="value" id="k43">-</div></div>
      <div class="card"><div class="title">主要2社シェア（42期）</div><div class="value" id="kshare42">-</div></div>
      <div class="card"><div class="title">主要2社シェア（43期 3–7）</div><div class="value" id="kshare43">-</div></div>
    </div>
    <div class="alert" id="anomaly" style="display:none"></div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3 style="margin:0 0 6px">42期：月次売上（海外のみ）</h3>
      <div id="chart42"></div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px">43期：月次売上（3–7月／海外のみ）</h3>
      <div id="chart43"></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3 style="margin:0 0 6px">42期：組織別シェア</h3>
      <div id="chartOrg42"></div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px">43期：組織別シェア（3–7月）</h3>
      <div id="chartOrg43"></div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3 style="margin:0 0 6px">The Link Group / Holden：月次推移（42期）</h3>
      <div id="chartTLGHolden42"></div>
    </div>
    <div class="panel">
      <h3 style="margin:0 0 6px">The Link Group / Holden：月次推移（43期 3–7月）</h3>
      <div id="chartTLGHolden43"></div>
    </div>
  </div>

  <div class="panel foot">
    <div>※ 単位：円（税抜）。月次＝「期×月」で集計。組織は海外クライアントのみ（画像掲載の組織）。表記ゆれは自動統一。43期は 3〜7月のみ集計。<br>※ うまく読み込めない場合は、Excelのシート名が <b>売上Data</b> になっているか、月の列が <b>"3月" 形式</b>かを確認してください（数字のときも自動補正します）。</div>
  </div>
</div>

<script>
// ===== 設定 & 正規化 =====
const ALLOWED_ORGS = [
  "AM-Pharma B.V.",
  "Asia Medical & Professional Research",
  "Borderless Access Private Limited",
  "Cathaya Technologies LLC",
  "Cello Health Insight",
  "Escalent",
  "FieldCats, Inc.",
  "GLocalMind Inc.",
  "Holden",
  "Insync",
  "Just-Worldwide",
  "M3 Global Research",
  "Market Xcel USA",
  "Medefield",
  "Medicem Group a.s.",
  "PSL Group Services SARL",
  "Purdie Pascoe",
  "QualWorld",
  "Survey Healthcare Globus",
  "The Link Group",
  "The Planning Shop",
  "sermo",
  // 追加（漏れ対策）
  "Blue Matter",
  "ifop"
];

const MONTHS_42 = ["3月","4月","5月","6月","7月","8月","9月","10月","11月","12月","1月","2月"];
const MONTHS_43 = ["3月","4月","5月","6月","7月"]; // 途中

function normalizeOrg(name){
  if(!name) return ""; const raw=String(name).trim(); const low=raw.toLowerCase().replace(/[\s‐ー―-]+/g,"");
  if(low.includes("holden")||low.includes("interfaceholden")||low.includes("interfaceasiaholden")) return "Holden";
  if(low.includes("fieldcats")) return "FieldCats, Inc.";
  if(low.startsWith("psl")) return "PSL Group Services SARL";
  if(low.includes("sermo")) return "sermo";
  if(low.includes("glocalmind")) return "GLocalMind Inc.";
  if(low.includes("theplanningshop")) return "The Planning Shop";
  if(low.includes("justworldwide")) return "Just-Worldwide";
  if(low.includes("marketxcel")) return "Market Xcel USA";
  if(/\bm3\b/.test(low)&&low.includes("research")) return "M3 Global Research";
  if(low.includes("cellohealthinsight")) return "Cello Health Insight";
  if(low.includes("surveyhealthcareglobus")) return "Survey Healthcare Globus";
  if(low.includes("asiamedical")) return "Asia Medical & Professional Research";
  if(low.includes("borderlessaccess")) return "Borderless Access Private Limited";
  if(low.includes("cathaya")) return "Cathaya Technologies LLC";
  if(low.includes("medefield")) return "Medefield";
  if(low.includes("medicemgroup")) return "Medicem Group a.s.";
  if(low.includes("am-pharma")||low.includes("ampharma")) return "AM-Pharma B.V.";
  if(low.includes("insync")) return "Insync";
  if(low.includes("qualworld")) return "QualWorld";
  if(low.includes("thelinkgroup")) return "The Link Group";
  if(low.includes("bluematter")) return "Blue Matter";
  if(low==="ifop") return "ifop";
  return raw;
}

function normalizeMonth(m){
  const s = String(m).trim();
  if(/^[0-9]{1,2}$/.test(s)) return s+"月"; // 数字 → "n月" に補正
  return s;
}

// ===== Excel読込 =====
const input = document.getElementById('file');
const btnLoad = document.getElementById('btnLoad');
const errBox = document.getElementById('err');
let ROWS = [];

async function readExcel(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:'array'});
  const sheet = wb.Sheets['売上Data'];
  if(!sheet) throw new Error('シート「売上Data」が見つかりません');
  const rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
  return rows.map(r=>({
    期: String(r['期']).trim(),
    月: normalizeMonth(r['月']),
    組織: normalizeOrg(r['組織']),
    売上: Number(r['売上（税抜）'])||0
  }));
}

btnLoad.addEventListener('click', async()=>{
  errBox.style.display='none'; errBox.textContent='';
  try{
    if(!input.files?.length) throw new Error('Excelファイル（売上Dataシート）を選択してください');
    ROWS = await readExcel(input.files[0]);
    build();
  }catch(e){
    errBox.style.display='block';
    errBox.textContent = '読み込みエラー：'+ (e && e.message ? e.message : e);
  }
});

// ===== 集計 =====
function aggregate(){
  const overseas = ROWS.filter(r=>ALLOWED_ORGS.includes(r.組織));
  const f42 = overseas.filter(r=>r.期==='42期');
  const f43 = overseas.filter(r=>r.期==='43期' && MONTHS_43.includes(r.月));

  const sum = arr => arr.reduce((a,b)=>a+b,0);

  // 月次
  const m42 = MONTHS_42.map(m=>({月:m, 売上: sum(f42.filter(r=>r.月===m).map(r=>r.売上))}))
  const m43 = MONTHS_43.map(m=>({月:m, 売上: sum(f43.filter(r=>r.月===m).map(r=>r.売上))}))

  // 組織別トータル
  const org42 = {} , org43 = {};
  for(const r of f42){ org42[r.組織]=(org42[r.組織]||0)+r.売上 }
  for(const r of f43){ org43[r.組織]=(org43[r.組織]||0)+r.売上 }

  // TLG/Holden 月次
  const tlg42 = MONTHS_42.map(m=>({月:m, 売上: sum(f42.filter(r=>r.月===m && r.組織==='The Link Group').map(r=>r.売上))}))
  const hdn42 = MONTHS_42.map(m=>({月:m, 売上: sum(f42.filter(r=>r.月===m && r.組織==='Holden').map(r=>r.売上))}))
  const tlg43 = MONTHS_43.map(m=>({月:m, 売上: sum(f43.filter(r=>r.月===m && r.組織==='The Link Group').map(r=>r.売上))}))
  const hdn43 = MONTHS_43.map(m=>({月:m, 売上: sum(f43.filter(r=>r.月===m && r.組織==='Holden').map(r=>r.売上))}))

  return {m42,m43,org42,org43,tlg42,hdn42,tlg43,hdn43};
}

// ===== 描画 =====
const palette=['#8884d8','#82ca9d','#ffc658','#d0ed57','#a4de6c','#8dd1e1','#ff8042','#00C49F','#FFBB28','#FF8042','#E7B84B','#57C4E5','#A5D6A7','#FFD54F','#9575CD','#4DB6AC','#FFAB91','#64B5F6','#BA68C8','#DCE775'];
function yenShort(v){ if(v>=1e8) return (v/1e8).toFixed(2)+'億'; if(v>=1e6) return (v/1e6).toFixed(1)+'百万円'; return String(v); }

function drawBar(el, data){
  const x = echarts.init(document.getElementById(el));
  x.setOption({
    tooltip:{trigger:'axis',valueFormatter:v=>Number(v).toLocaleString()+"円"},
    grid:{left:60,right:20,top:20,bottom:40},
    xAxis:{type:'category',data:data.map(d=>d.月)},
    yAxis:{type:'value',axisLabel:{formatter:(v)=>yenShort(v)}},
    series:[{type:'bar',data:data.map(d=>d.売上),itemStyle:{color:palette[0]}}]
  });
}

function drawShare(el, dict){
  const items = Object.entries(dict).sort((a,b)=>b[1]-a[1]);
  const top = items.slice(0,12);
  const x = echarts.init(document.getElementById(el));
  x.setOption({
    tooltip:{trigger:'item',valueFormatter:v=>Number(v).toLocaleString()+"円"},
    grid:{left:120,right:20,top:10,bottom:30},
    xAxis:{type:'value'},
    yAxis:{type:'category',data:top.map(([k])=>k)},
    series:[{type:'bar',data:top.map(([k,v])=>v),itemStyle:{color:palette[3]}}]
  });
}

function drawLines(el, tlg, hdn){
  const x = echarts.init(document.getElementById(el));
  x.setOption({
    tooltip:{trigger:'axis',valueFormatter:v=>Number(v).toLocaleString()+"円"},
    grid:{left:60,right:20,top:20,bottom:40},
    xAxis:{type:'category',data:tlg.map(d=>d.月)},
    yAxis:{type:'value',axisLabel:{formatter:(v)=>yenShort(v)}},
    legend:{data:['The Link Group','Holden']},
    series:[
      {name:'The Link Group',type:'line',data:tlg.map(d=>d.売上),smooth:true,itemStyle:{color:palette[8]}},
      {name:'Holden',type:'line',data:hdn.map(d=>d.売上),smooth:true,itemStyle:{color:palette[6]}}
    ]
  });
}

function fmtYen(n){return Number(n).toLocaleString()+"円"}

function build(){
  const {m42,m43,org42,org43,tlg42,hdn42,tlg43,hdn43} = aggregate();
  // KPI
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const k42 = sum(m42.map(d=>d.売上));
  const k43 = sum(m43.map(d=>d.売上));
  document.getElementById('k42').textContent = fmtYen(k42);
  document.getElementById('k43').textContent = fmtYen(k43);

  const tlg42Sum = org42['The Link Group']||0; const hdn42Sum = org42['Holden']||0;
  const tlg43Sum = org43['The Link Group']||0; const hdn43Sum = org43['Holden']||0;
  const share42 = ((tlg42Sum+hdn42Sum)/Math.max(1,k42)*100).toFixed(1)+'%';
  const share43 = ((tlg43Sum+hdn43Sum)/Math.max(1,k43)*100).toFixed(1)+'%';
  document.getElementById('kshare42').textContent = share42;
  document.getElementById('kshare43').textContent = share43;

  // アノマリー（43期6月）
  const m6 = m43.find(d=>d.月==='6月');
  const box = document.getElementById('anomaly');
  if(m6){
    const prev = m43.find(d=>d.月==='5月');
    const diff = prev? m6.売上 - prev.売上 : m6.売上;
    const tlg6 = tlg43.find(d=>d.月==='6月')?.売上||0; const hdn6 = hdn43.find(d=>d.月==='6月')?.売上||0;
    box.style.display='block';
    box.innerHTML = `43期 <b>6月</b> 売上は <b>${fmtYen(m6.売上)}</b>（前月差 ${fmtYen(diff)}）。内訳：TLG=${fmtYen(tlg6)}、Holden=${fmtYen(hdn6)}。`;
  } else { box.style.display='none'; }

  // Charts
  drawBar('chart42', m42);
  drawBar('chart43', m43);
  drawShare('chartOrg42', org42);
  drawShare('chartOrg43', org43);
  drawLines('chartTLGHolden42', tlg42, hdn42);
  drawLines('chartTLGHolden43', tlg43, hdn43);
}

// 画像保存（各チャートを個別保存）
document.getElementById('btnDownload').addEventListener('click',()=>{
  const ids=['chart42','chart43','chartOrg42','chartOrg43','chartTLGHolden42','chartTLGHolden43'];
  ids.forEach((id)=>{
    const inst = echarts.getInstanceByDom(document.getElementById(id));
    if(inst){
      const url = inst.getDataURL({pixelRatio:2,backgroundColor:'#fff'});
      const a=document.createElement('a'); a.href=url; a.download=`infographic_${id}.png`; a.click();
    }
  });
});

window.addEventListener('resize', ()=>{
  ['chart42','chart43','chartOrg42','chartOrg43','chartTLGHolden42','chartTLGHolden43'].forEach(id=>{
    const inst=echarts.getInstanceByDom(document.getElementById(id)); if(inst) inst.resize();
  })
});
</script>
</body>
</html>
